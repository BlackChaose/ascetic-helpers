"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = require("lodash");

// todo validation function //html5 + html4 && IE 10/11 support;
// todo
const sendRequest = url => {
  /* eslint-disable */
  const xhttp = new XMLHttpRequest();
  /* eslint-enable */

  const req = new Promise((resolve, reject) => {
    xhttp.onreadystatechange = function () {
      if (this.readyState === 4 && this.status === 200) {
        // eslint-disable-line
        const result = xhttp.responseText;
        resolve(JSON.parse(result));
      } else if (this.readyState === 4 && this.status !== 200) {
        reject(new Error(`Error! ${this.readyState} ${this.status}`));
      }
    };

    xhttp.open('POST', url, true);
    xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xhttp.send('mobile_codes=get');
  });
  return req;
};

const renderLabel = obj => {
  const labelInput = document.createElement('label'); // eslint-disable-line

  labelInput.for = obj.getElementsByTagName('input').id;
  labelInput.textContent = ' +';
  obj.append(labelInput);
  return obj;
};

const mobileFormat = arr => {
  const str = (0, _lodash.reduce)(arr, (acc, item, key) => {
    let res = acc;

    if (key === 2 || key === 5) {
      res += item;
      res += ' - ';
      return res;
    }

    res += item;
    return res;
  }, '');
  return str;
};

const renderDropDownList = (obj, SortedFlags, inputMobileDefault, inputCountryCodeDefault) => {
  const dropDownHeader = document.createElement('span'); // eslint-disable-line

  const dropDownInput = document.createElement('input'); // eslint-disable-line

  const dropDownList = document.createElement('div'); // eslint-disable-line

  dropDownList.className = 'mobile_input--dropdown-list';
  dropDownHeader.className = 'mobile_input--dropdown-header';
  dropDownInput.className = 'mobile_input--dropdown-input';
  dropDownInput.name = 'country_code';
  dropDownInput.readOnly = true;
  dropDownInput.placeholder = 'код';
  dropDownInput.maxLength = 4;
  dropDownInput.value = inputCountryCodeDefault;
  dropDownHeader.append(dropDownInput);
  const ul = document.createElement('ul'); // eslint-disable-line

  ul.className = 'mobile_input--dropdown-ul';
  (0, _lodash.forEach)(SortedFlags, el => {
    const li = document.createElement('li'); // eslint-disable-line

    let imgFlag = document.createElement('span'); // eslint-disable-line

    let liText = document.createElement('span'); // eslint-disable-line

    li.className = 'mobile_input--dropdown-li';
    imgFlag.className = 'mobile_input--dropdown-imgflag';
    liText.className = 'mobile_input--dropdown-litext';
    liText.textContent = el.mobile_code;
    imgFlag.style.backgroundImage = `url(../img/flags/${el.flag_picture_name})`; // imgFlag.style.backgroundImage = `url(img/flags/${el.flag_picture_name})`;

    li.appendChild(imgFlag);
    li.appendChild(liText);
    li.title = el.name_cyr;
    li.addEventListener('click', () => {
      dropDownInput.value = liText.textContent;
      dropDownList.style.display = 'none';
    });
    ul.append(li);
  });
  dropDownList.append(ul);
  const mobileInput = document.createElement('input'); // eslint-disable-line

  mobileInput.className = 'mobile_input--mobile-input';
  mobileInput.pattern = '\\d{3}(\\s|-)\\d{3}(\\s|-)\\d{4}';
  mobileInput.placeholder = 'XXX-XXX-XXXX';
  mobileInput.title = 'номер мобильного телефона';
  mobileInput.type = 'tel';
  mobileInput.required = true;
  mobileInput.value = mobileFormat(inputMobileDefault);
  mobileInput.name = 'Mobile';
  obj.append(dropDownHeader);
  obj.append(mobileInput);
  obj.append(dropDownList);
  const keybuf = [];
  mobileInput.addEventListener('keydown', e => {
    if (isNaN(parseInt(e.key, 10)) && e.key !== 'Backspace' && e.key !== 'Enter') {
      // eslint-disable-line
      e.preventDefault();
    }

    if (keybuf.length >= 10 && e.key !== 'Backspace') {
      e.preventDefault();
      return;
    }

    if (e.key === 'Backspace') {
      mobileInput.value = '';
      mobileInput.value = mobileFormat(keybuf);
      keybuf.pop();
      return;
    }

    mobileInput.value = '';
    mobileInput.value = mobileFormat(keybuf);
    keybuf.push(e.key);
  });
  dropDownList.addEventListener('mouseleave', () => {
    dropDownList.style.display = 'none';
  });
  dropDownInput.addEventListener('click', () => {
    dropDownList.style.display = dropDownList.style.display === 'block' ? 'none' : 'block';
  });
  mobileInput.addEventListener('focusin', () => {
    dropDownList.style.display = 'none';
  });
  return obj;
};

const upUsedCountry = (codes, countries) => {
  const upList = codes.filter(el => countries.includes(el.name_lat));
  const result = upList.concat(codes);
  return result;
};

const formatCodes = arr => {
  const sortArr = (0, _lodash.sortBy)(arr.mobile_codes, [o => o.name_cyr]);
  return upUsedCountry(sortArr, ['Russia', 'Belarus', 'Finland', 'Kazakhstan', 'Kyrgyzstan', 'Azerbaijan', 'Armenia', 'Moldova', 'Tajikistan', 'Uzbekistan']);
};

const renderMobileInput = config => {
  sendRequest(config.url).then(MobileCodes => {
    const SortedMobileCodes = formatCodes(MobileCodes);
    renderLabel(config.domObject);
    renderDropDownList(config.domObject, SortedMobileCodes, config.defaultMobile, config.defaultCountryCode);
  }).catch(error => console.log(error));
  return 0;
};

var _default = renderMobileInput;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2JpbGVJbnB1dENvbXBvbmVudC5qcyJdLCJuYW1lcyI6WyJzZW5kUmVxdWVzdCIsInVybCIsInhodHRwIiwiWE1MSHR0cFJlcXVlc3QiLCJyZXEiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIm9ucmVhZHlzdGF0ZWNoYW5nZSIsInJlYWR5U3RhdGUiLCJzdGF0dXMiLCJyZXN1bHQiLCJyZXNwb25zZVRleHQiLCJKU09OIiwicGFyc2UiLCJFcnJvciIsIm9wZW4iLCJzZXRSZXF1ZXN0SGVhZGVyIiwic2VuZCIsInJlbmRlckxhYmVsIiwib2JqIiwibGFiZWxJbnB1dCIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImZvciIsImdldEVsZW1lbnRzQnlUYWdOYW1lIiwiaWQiLCJ0ZXh0Q29udGVudCIsImFwcGVuZCIsIm1vYmlsZUZvcm1hdCIsImFyciIsInN0ciIsImFjYyIsIml0ZW0iLCJrZXkiLCJyZXMiLCJyZW5kZXJEcm9wRG93bkxpc3QiLCJTb3J0ZWRGbGFncyIsImlucHV0TW9iaWxlRGVmYXVsdCIsImlucHV0Q291bnRyeUNvZGVEZWZhdWx0IiwiZHJvcERvd25IZWFkZXIiLCJkcm9wRG93bklucHV0IiwiZHJvcERvd25MaXN0IiwiY2xhc3NOYW1lIiwibmFtZSIsInJlYWRPbmx5IiwicGxhY2Vob2xkZXIiLCJtYXhMZW5ndGgiLCJ2YWx1ZSIsInVsIiwiZWwiLCJsaSIsImltZ0ZsYWciLCJsaVRleHQiLCJtb2JpbGVfY29kZSIsInN0eWxlIiwiYmFja2dyb3VuZEltYWdlIiwiZmxhZ19waWN0dXJlX25hbWUiLCJhcHBlbmRDaGlsZCIsInRpdGxlIiwibmFtZV9jeXIiLCJhZGRFdmVudExpc3RlbmVyIiwiZGlzcGxheSIsIm1vYmlsZUlucHV0IiwicGF0dGVybiIsInR5cGUiLCJyZXF1aXJlZCIsImtleWJ1ZiIsImUiLCJpc05hTiIsInBhcnNlSW50IiwicHJldmVudERlZmF1bHQiLCJsZW5ndGgiLCJwb3AiLCJwdXNoIiwidXBVc2VkQ291bnRyeSIsImNvZGVzIiwiY291bnRyaWVzIiwidXBMaXN0IiwiZmlsdGVyIiwiaW5jbHVkZXMiLCJuYW1lX2xhdCIsImNvbmNhdCIsImZvcm1hdENvZGVzIiwic29ydEFyciIsIm1vYmlsZV9jb2RlcyIsIm8iLCJyZW5kZXJNb2JpbGVJbnB1dCIsImNvbmZpZyIsInRoZW4iLCJNb2JpbGVDb2RlcyIsIlNvcnRlZE1vYmlsZUNvZGVzIiwiZG9tT2JqZWN0IiwiZGVmYXVsdE1vYmlsZSIsImRlZmF1bHRDb3VudHJ5Q29kZSIsImNhdGNoIiwiZXJyb3IiLCJjb25zb2xlIiwibG9nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBSUE7QUFDQTtBQUNBLE1BQU1BLFdBQVcsR0FBSUMsR0FBRCxJQUFTO0FBQzNCO0FBQ0EsUUFBTUMsS0FBSyxHQUFHLElBQUlDLGNBQUosRUFBZDtBQUNBOztBQUNBLFFBQU1DLEdBQUcsR0FBRyxJQUFJQyxPQUFKLENBQWEsQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQzVDTCxJQUFBQSxLQUFLLENBQUNNLGtCQUFOLEdBQTJCLFlBQVk7QUFDckMsVUFBSSxLQUFLQyxVQUFMLEtBQW9CLENBQXBCLElBQXlCLEtBQUtDLE1BQUwsS0FBZ0IsR0FBN0MsRUFBa0Q7QUFBRTtBQUNsRCxjQUFNQyxNQUFNLEdBQUdULEtBQUssQ0FBQ1UsWUFBckI7QUFDQU4sUUFBQUEsT0FBTyxDQUFDTyxJQUFJLENBQUNDLEtBQUwsQ0FBV0gsTUFBWCxDQUFELENBQVA7QUFDRCxPQUhELE1BR08sSUFBSSxLQUFLRixVQUFMLEtBQW9CLENBQXBCLElBQXlCLEtBQUtDLE1BQUwsS0FBZ0IsR0FBN0MsRUFBa0Q7QUFDdkRILFFBQUFBLE1BQU0sQ0FBQyxJQUFJUSxLQUFKLENBQVcsVUFBUyxLQUFLTixVQUFXLElBQUcsS0FBS0MsTUFBTyxFQUFuRCxDQUFELENBQU47QUFDRDtBQUNGLEtBUEQ7O0FBUUFSLElBQUFBLEtBQUssQ0FBQ2MsSUFBTixDQUFXLE1BQVgsRUFB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QVM7QUFDM0IsUUFBTXNELE9BQU8sR0FBRyxvQkFBT3RELEdBQUcsQ0FBQ3VELFlBQVgsRUFBeUIsQ0FBRUMsQ0FBRCxJQUFPQSxDQUFDLENBQUMxQixRQUFWLENBQXpCLENBQWhCO0FBQ0EsU0FBT2UsYUFBYSxDQUFDUyxPQUFELEVBQVUsQ0FBQyxRQUFELEVBQVcsU0FBWCxFQUFzQixTQUF0QixFQUFpQyxZQUFqQyxFQUErQyxZQUEvQyxFQUE2RCxZQUE3RCxFQUEyRSxTQUEzRSxFQUFzRixTQUF0RixFQUFpRyxZQUFqRyxFQUErRyxZQUEvRyxDQUFWLENBQXBCO0FBQ0QsQ0FIRDs7QUFLQSxNQUFNRyxpQkFBaUIsR0FBSUMsTUFBRCxJQUFZO0FBQ3BDeEYsRUFBQUEsV0FBVyxDQUFDd0YsTUFBTSxDQUFDdkYsR0FBUixDQUFYLENBQ0d3RixJQURILENBQ1NDLFdBQUQsSUFBaUI7QUFDckIsVUFBTUMsaUJBQWlCLEdBQUdSLFdBQVcsQ0FBQ08sV0FBRCxDQUFyQztBQUNBdkUsSUFBQUEsV0FBVyxDQUFDcUUsTUFBTSxDQUFDSSxTQUFSLENBQVg7QUFDQXhELElBQUFBLGtCQUFrQixDQUFDb0QsTUFBTSxDQUFDSSxTQUFSLEVBQ2hCRCxpQkFEZ0IsRUFDR0gsTUFBTSxDQUFDSyxhQURWLEVBQ3lCTCxNQUFNLENBQUNNLGtCQURoQyxDQUFsQjtBQUVELEdBTkgsRUFPR0MsS0FQSCxDQU9VQyxLQUFELElBQVdDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRixLQUFaLENBUHBCO0FBUUEsU0FBTyxDQUFQO0FBQ0QsQ0FWRDs7ZUFZZVQsaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBmb3JFYWNoLCBzb3J0QnksIHJlZHVjZSxcbn0gZnJvbSAnbG9kYXNoJztcblxuLy8gdG9kbyB2YWxpZGF0aW9uIGZ1bmN0aW9uIC8vaHRtbDUgKyBodG1sNCAmJiBJRSAxMC8xMSBzdXBwb3J0O1xuLy8gdG9kb1xuY29uc3Qgc2VuZFJlcXVlc3QgPSAodXJsKSA9PiB7XG4gIC8qIGVzbGludC1kaXNhYmxlICovXG4gIGNvbnN0IHhodHRwID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gIC8qIGVzbGludC1lbmFibGUgKi9cbiAgY29uc3QgcmVxID0gbmV3IFByb21pc2UoKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICB4aHR0cC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSA0ICYmIHRoaXMuc3RhdHVzID09PSAyMDApIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgICAgICBjb25zdCByZXN1bHQgPSB4aHR0cC5yZXNwb25zZVRleHQ7XG4gICAgICAgIHJlc29sdmUoSlNPTi5wYXJzZShyZXN1bHQpKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5yZWFkeVN0YXRlID09PSA0ICYmIHRoaXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgRXJyb3IhICR7dGhpcy5yZWFkeVN0YXRlfSAke3RoaXMuc3RhdHVzfWApKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHhodHRwLm9wZW4oJ1BPU1QnLCB1cmwsIHRydWUpO1xuICAgIHhodHRwLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtdHlwZScsICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnKTtcbiAgICB4aHR0cC5zZW5kKCdtb2JpbGVfY29kZXM9Z2V0Jyk7XG4gIH0pKTtcbiAgcmV0dXJuIHJlcTtcbn07XG5cbmNvbnN0IHJlbmRlckxhYmVsID0gKG9iaikgPT4ge1xuICBjb25zdCBsYWJlbElucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGFiZWwnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICBsYWJlbElucHV0LmZvciA9IG9iai5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW5wdXQnKS5pZDtcbiAgbGFiZWxJbnB1dC50ZXh0Q29udGVudCA9ICcgKyc7XG4gIG9iai5hcHBlbmQobGFiZWxJbnB1dCk7XG4gIHJldHVybiBvYmo7XG59O1xuXG5jb25zdCBtb2JpbGVGb3JtYXQgPSAoYXJyKSA9PiB7XG4gIGNvbnN0IHN0ciA9IHJlZHVjZShhcnIsIChhY2MsIGl0ZW0sIGtleSkgPT4ge1xuICAgIGxldCByZXMgPSBhY2M7XG4gICAgaWYgKGtleSA9PT0gMiB8fCBrZXkgPT09IDUpIHtcbiAgICAgIHJlcyArPSBpdGVtO1xuICAgICAgcmVzICs9ICcgLSAnO1xuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG4gICAgcmVzICs9IGl0ZW07XG4gICAgcmV0dXJuIHJlcztcbiAgfSwgJycpO1xuICByZXR1cm4gc3RyO1xufTtcblxuY29uc3QgcmVuZGVyRHJvcERvd25MaXN0ID0gKG9iaiwgU29ydGVkRmxhZ3MsIGlucHV0TW9iaWxlRGVmYXVsdCwgaW5wdXRDb3VudHJ5Q29kZURlZmF1bHQpID0+IHtcbiAgY29uc3QgZHJvcERvd25IZWFkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgY29uc3QgZHJvcERvd25JbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgY29uc3QgZHJvcERvd25MaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcblxuICBkcm9wRG93bkxpc3QuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24tbGlzdCc7XG4gIGRyb3BEb3duSGVhZGVyLmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLWRyb3Bkb3duLWhlYWRlcic7XG4gIGRyb3BEb3duSW5wdXQuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24taW5wdXQnO1xuICBkcm9wRG93bklucHV0Lm5hbWUgPSAnY291bnRyeV9jb2RlJztcbiAgZHJvcERvd25JbnB1dC5yZWFkT25seSA9IHRydWU7XG4gIGRyb3BEb3duSW5wdXQucGxhY2Vob2xkZXIgPSAn0LrQvtC0JztcbiAgZHJvcERvd25JbnB1dC5tYXhMZW5ndGggPSA0O1xuICBkcm9wRG93bklucHV0LnZhbHVlID0gaW5wdXRDb3VudHJ5Q29kZURlZmF1bHQ7XG5cbiAgZHJvcERvd25IZWFkZXIuYXBwZW5kKGRyb3BEb3duSW5wdXQpO1xuXG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndWwnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICB1bC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1kcm9wZG93bi11bCc7XG5cbiAgZm9yRWFjaChTb3J0ZWRGbGFncywgKGVsKSA9PiB7XG4gICAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgbGV0IGltZ0ZsYWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgICBsZXQgbGlUZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgbGkuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24tbGknO1xuICAgIGltZ0ZsYWcuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24taW1nZmxhZyc7XG4gICAgbGlUZXh0LmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLWRyb3Bkb3duLWxpdGV4dCc7XG5cbiAgICBsaVRleHQudGV4dENvbnRlbnQgPSBlbC5tb2JpbGVfY29kZTtcblxuICAgIGltZ0ZsYWcuc3R5bGUuYmFja2dyb3VuZEltYWdlID0gYHVybCguLi9pbWcvZmxhZ3MvJHtlbC5mbGFnX3BpY3R1cmVfbmFtZX0pYDtcbiAgICAvLyBpbWdGbGFnLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9IGB1cmwoaW1nL2ZsYWdzLyR7ZWwuZmxhZ19waWN0dXJlX25hbWV9KWA7XG5cbiAgICBsaS5hcHBlbmRDaGlsZChpbWdGbGFnKTtcbiAgICBsaS5hcHBlbmRDaGlsZChsaVRleHQpO1xuXG4gICAgbGkudGl0bGUgPSBlbC5uYW1lX2N5cjtcbiAgICBsaS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgIGRyb3BEb3duSW5wdXQudmFsdWUgPSBsaVRleHQudGV4dENvbnRlbnQ7XG4gICAgICBkcm9wRG93bkxpc3Quc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICB9KTtcbiAgICB1bC5hcHBlbmQobGkpO1xuICB9KTtcblxuICBkcm9wRG93bkxpc3QuYXBwZW5kKHVsKTtcblxuICBjb25zdCBtb2JpbGVJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgbW9iaWxlSW5wdXQuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tbW9iaWxlLWlucHV0JztcbiAgbW9iaWxlSW5wdXQucGF0dGVybiA9ICdcXFxcZHszfShcXFxcc3wtKVxcXFxkezN9KFxcXFxzfC0pXFxcXGR7NH0nO1xuICBtb2JpbGVJbnB1dC5wbGFjZWhvbGRlciA9ICdYWFgtWFhYLVhYWFgnO1xuICBtb2JpbGVJbnB1dC50aXRsZSA9ICfQvdC+0LzQtdGAINC80L7QsdC40LvRjNC90L7Qs9C+INGC0LXQu9C10YTQvtC90LAnO1xuICBtb2JpbGVJbnB1dC50eXBlID0gJ3RlbCc7XG4gIG1vYmlsZUlucHV0LnJlcXVpcmVkID0gdHJ1ZTtcbiAgbW9iaWxlSW5wdXQudmFsdWUgPSBtb2JpbGVGb3JtYXQoaW5wdXRNb2JpbGVEZWZhdWx0KTtcbiAgbW9iaWxlSW5wdXQubmFtZSA9ICdNb2JpbGUnO1xuXG4gIG9iai5hcHBlbmQoZHJvcERvd25IZWFkZXIpO1xuXG4gIG9iai5hcHBlbmQobW9iaWxlSW5wdXQpO1xuXG4gIG9iai5hcHBlbmQoZHJvcERvd25MaXN0KTtcblxuXG4gIGNvbnN0IGtleWJ1ZiA9IFtdO1xuICBtb2JpbGVJbnB1dC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHtcbiAgICBpZiAoaXNOYU4ocGFyc2VJbnQoZS5rZXksIDEwKSkgJiYgZS5rZXkgIT09ICdCYWNrc3BhY2UnICYmIGUua2V5ICE9PSAnRW50ZXInKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG4gICAgaWYgKGtleWJ1Zi5sZW5ndGggPj0gMTAgJiYgZS5rZXkgIT09ICdCYWNrc3BhY2UnKSB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChlLmtleSA9PT0gJ0JhY2tzcGFjZScpIHtcbiAgICAgIG1vYmlsZUlucHV0LnZhbHVlID0gJyc7XG4gICAgICBtb2JpbGVJbnB1dC52YWx1ZSA9IG1vYmlsZUZvcm1hdChrZXlidWYpO1xuICAgICAga2V5YnVmLnBvcCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIG1vYmlsZUlucHV0LnZhbHVlID0gJyc7XG4gICAgbW9iaWxlSW5wdXQudmFsdWUgPSBtb2JpbGVGb3JtYXQoa2V5YnVmKTtcbiAgICBrZXlidWYucHVzaChlLmtleSk7XG4gIH0pO1xuXG4gIGRyb3BEb3duTGlzdC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgKCkgPT4ge1xuICAgIGRyb3BEb3duTGlzdC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICB9KTtcblxuICBkcm9wRG93bklucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgIGRyb3BEb3duTGlzdC5zdHlsZS5kaXNwbGF5ID0gKGRyb3BEb3duTGlzdC5zdHlsZS5kaXNwbGF5ID09PSAnYmxvY2snKSA/ICdub25lJyA6ICdibG9jayc7XG4gIH0pO1xuXG4gIG1vYmlsZUlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2ZvY3VzaW4nLCAoKSA9PiB7XG4gICAgZHJvcERvd25MaXN0LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gIH0pO1xuXG4gIHJldHVybiBvYmo7XG59O1xuXG5jb25zdCB1cFVzZWRDb3VudHJ5ID0gKGNvZGVzLCBjb3VudHJpZXMpID0+IHtcbiAgY29uc3QgdXBMaXN0ID0gY29kZXMuZmlsdGVyKChlbCkgPT4gY291bnRyaWVzLmluY2x1ZGVzKGVsLm5hbWVfbGF0KSk7XG4gIGNvbnN0IHJlc3VsdCA9IHVwTGlzdC5jb25jYXQoY29kZXMpO1xuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgZm9ybWF0Q29kZXMgPSAoYXJyKSA9PiB7XG4gIGNvbnN0IHNvcnRBcnIgPSBzb3J0QnkoYXJyLm1vYmlsZV9jb2RlcywgWyhvKSA9PiBvLm5hbWVfY3lyXSk7XG4gIHJldHVybiB1cFVzZWRDb3VudHJ5KHNvcnRBcnIsIFsnUnVzc2lhJywgJ0JlbGFydXMnLCAnRmlubGFuZCcsICdLYXpha2hzdGFuJywgJ0t5cmd5enN0YW4nLCAnQXplcmJhaWphbicsICdBcm1lbmlhJywgJ01vbGRvdmEnLCAnVGFqaWtpc3RhbicsICdVemJla2lzdGFuJ10pO1xufTtcblxuY29uc3QgcmVuZGVyTW9iaWxlSW5wdXQgPSAoY29uZmlnKSA9PiB7XG4gIHNlbmRSZXF1ZXN0KGNvbmZpZy51cmwpXG4gICAgLnRoZW4oKE1vYmlsZUNvZGVzKSA9PiB7XG4gICAgICBjb25zdCBTb3J0ZWRNb2JpbGVDb2RlcyA9IGZvcm1hdENvZGVzKE1vYmlsZUNvZGVzKTtcbiAgICAgIHJlbmRlckxhYmVsKGNvbmZpZy5kb21PYmplY3QpO1xuICAgICAgcmVuZGVyRHJvcERvd25MaXN0KGNvbmZpZy5kb21PYmplY3QsXG4gICAgICAgIFNvcnRlZE1vYmlsZUNvZGVzLCBjb25maWcuZGVmYXVsdE1vYmlsZSwgY29uZmlnLmRlZmF1bHRDb3VudHJ5Q29kZSk7XG4gICAgfSlcbiAgICAuY2F0Y2goKGVycm9yKSA9PiBjb25zb2xlLmxvZyhlcnJvcikpO1xuICByZXR1cm4gMDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IHJlbmRlck1vYmlsZUlucHV0O1xuIl19