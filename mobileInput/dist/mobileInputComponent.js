"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = require("lodash");

var sendRequest = function sendRequest(url) {
  /* eslint-disable */
  var xhttp = new XMLHttpRequest();
  var req = new Promise(function (resolve, reject) {
    xhttp.onreadystatechange = function () {
      if (this.readyState === 4 && this.status === 200) {
        // eslint-disable-line
        var result = xhttp.responseText;
        resolve(JSON.parse(result));
      } else if (this.readyState === 4 && this.status !== 200) {
        reject(new Error("Error! ".concat(this.readyState, " ").concat(this.status)));
      }
    };

    xhttp.open('POST', url, true);
    xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xhttp.send('mobile_codes=get');
  });
  return req;
  /* eslint-enable */
};

var renderLabel = function renderLabel(obj) {
  var labelInput = document.createElement('label'); // eslint-disable-line

  labelInput.for = obj.getElementsByTagName('input').id;
  labelInput.textContent = ' +';
  obj.appendChild(labelInput);
  return obj;
};

var mobileFormat = function mobileFormat(arr) {
  var str = (0, _lodash.reduce)(arr, function (acc, item, key) {
    var res = acc;

    if (key === 2 || key === 5) {
      res += item;
      res += '-';
      return res;
    }

    res += item;
    return res;
  }, '');
  return str;
};

var renderDropDownList = function renderDropDownList(obj, SortedFlags, inputMobileDefault, inputCountryCodeDefault, hiddenInputName, borderStyle) {
  var dropDownHeader = document.createElement('span'); // eslint-disable-line

  var dropDownInput = document.createElement('input'); // eslint-disable-line

  var dropDownList = document.createElement('div'); // eslint-disable-line

  var dropDownHiddenInput = document.createElement('input'); // eslint-disable-line

  var dropDownArrow = document.createElement('div'); // eslint-disable-line

  dropDownList.className = 'mobile_input--dropdown-list';
  dropDownHeader.className = 'mobile_input--dropdown-header';

  if (borderStyle === 'red') {
    dropDownInput.className = 'mobile_input--dropdown-input-red';
  } else if (borderStyle === 'define') {
    dropDownInput.className = 'mobile_input--dropdown-input';
  }

  dropDownInput.name = 'country_code';
  dropDownInput.readOnly = true;
  dropDownInput.placeholder = 'код';
  dropDownInput.maxLength = 4;
  dropDownInput.value = inputCountryCodeDefault;
  dropDownHiddenInput.type = 'hidden';
  dropDownHiddenInput.name = hiddenInputName || 'mobileInput_Mobile';
  dropDownHeader.appendChild(dropDownInput);
  var ul = document.createElement('ul'); // eslint-disable-line

  ul.className = 'mobile_input--dropdown-ul';
  (0, _lodash.forEach)(SortedFlags, function (el) {
    var li = document.createElement('li'); // eslint-disable-line

    var imgFlag = document.createElement('span'); // eslint-disable-line

    var liText = document.createElement('span'); // eslint-disable-line

    li.className = 'mobile_input--dropdown-li';
    imgFlag.className = 'mobile_input--dropdown-imgflag';
    liText.className = 'mobile_input--dropdown-litext';
    liText.textContent = el.mobile_code;
    imgFlag.style.backgroundImage = "url(../img/flags/".concat(el.flag_picture_name, ")"); // imgFlag.style.backgroundImage = `url(img/flags/${el.flag_picture_name})`;

    li.appendChild(imgFlag);
    li.appendChild(liText);
    li.title = el.name_cyr;
    li.addEventListener('click', function () {
      dropDownInput.value = liText.textContent;
      dropDownList.style.display = 'none';
    });
    ul.appendChild(li);
  });
  dropDownList.appendChild(ul);
  var mobileInput = document.createElement('input'); // eslint-disable-line

  if (borderStyle === 'red') {
    mobileInput.className = 'mobile_input--mobile-input-red';
  } else if (borderStyle === 'define') {
    mobileInput.className = 'mobile_input--mobile-input';
  }

  mobileInput.pattern = '\\d{3}(\\s|-)\\d{3}(\\s|-)\\d{4}';
  mobileInput.placeholder = 'XXX-XXX-XXXX';
  mobileInput.title = 'номер мобильного телефона';
  mobileInput.type = 'tel';
  mobileInput.required = true;
  mobileInput.value = mobileFormat(inputMobileDefault);
  mobileInput.name = 'mobile_number';
  mobileInput.autocomplete = 'off';
  obj.appendChild(dropDownHeader);
  dropDownHeader.appendChild(dropDownArrow);
  obj.appendChild(mobileInput);
  obj.appendChild(dropDownList);
  dropDownHiddenInput.value = mobileFormat(inputMobileDefault);
  obj.appendChild(dropDownHiddenInput);

  var HiddenInputHandler = function HiddenInputHandler() {
    dropDownHiddenInput.value = dropDownInput.value + mobileInput.value;
    return dropDownHiddenInput.value;
  };

  var keybuf = inputMobileDefault.split('');
  console.warn('inputMobileDefault.split: ', keybuf); // по умолчанию в буфер + обработка нажатий стрелок

  mobileInput.addEventListener('change', function (e) {
    console.log(e.key);
  });
  mobileInput.addEventListener('keydown', function (e) {
    if (isNaN(parseInt(e.key, 10)) && e.key !== 'Backspace' && e.key !== 'Enter') {
      // eslint-disable-line
      e.preventDefault();
      return;
    }

    if (keybuf.length >= 10 && e.key !== 'Backspace') {
      e.preventDefault();
      return;
    }

    if (e.key === 'Backspace') {
      e.preventDefault();
      mobileInput.value = '';
      keybuf.pop();
      mobileInput.value = mobileFormat(keybuf);
      HiddenInputHandler();
      return;
    }

    e.preventDefault();
    mobileInput.value = '';
    keybuf.push(e.key);
    mobileInput.value = mobileFormat(keybuf);
    HiddenInputHandler();
  });
  dropDownList.addEventListener('mouseleave', function () {
    dropDownList.style.display = 'none';
    HiddenInputHandler();
  });
  dropDownInput.addEventListener('click', function () {
    dropDownList.style.display = dropDownList.style.display === 'block' ? 'none' : 'block';
    HiddenInputHandler();
  });
  dropDownArrow.className = 'mobile_input--dropdown-header-arrow';
  dropDownArrow.textContent = '▼';
  dropDownArrow.addEventListener('click', function () {
    dropDownList.style.display = dropDownList.style.display === 'block' ? 'none' : 'block';
    HiddenInputHandler();
  });
  mobileInput.addEventListener('focusin', function () {
    dropDownList.style.display = 'none';
    HiddenInputHandler();
  });
  return obj;
};

var upUsedCountry = function upUsedCountry(codes, countries) {
  var upList = codes.filter(function (el) {
    return countries.includes(el.name_lat);
  });
  var result = upList.concat(codes);
  return result;
};

var formatCodes = function formatCodes(arr) {
  var sortArr = (0, _lodash.sortBy)(arr.mobile_codes, [function (o) {
    return o.mobile_code;
  }]);
  return upUsedCountry(sortArr, ['Russia']);
};

var renderMobileInput = function renderMobileInput(config) {
  sendRequest(config.url).then(function (MobileCodes) {
    var SortedMobileCodes = formatCodes(MobileCodes);
    renderLabel(config.domObject);
    renderDropDownList(config.domObject, SortedMobileCodes, config.defaultMobile, config.defaultCountryCode, config.hiddenInputName, config.borderStyle);
  }).catch(function (error) {
    return console.log(error);
  });
  return 0;
};

var _default = renderMobileInput;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2JpbGVJbnB1dENvbXBvbmVudC5qcyJdLCJuYW1lcyI6WyJzZW5kUmVxdWVzdCIsInVybCIsInhodHRwIiwiWE1MSHR0cFJlcXVlc3QiLCJyZXEiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIm9ucmVhZHlzdGF0ZWNoYW5nZSIsInJlYWR5U3RhdGUiLCJzdGF0dXMiLCJyZXN1bHQiLCJyZXNwb25zZVRleHQiLCJKU09OIiwicGFyc2UiLCJFcnJvciIsIm9wZW4iLCJzZXRSZXF1ZXN0SGVhZGVyIiwic2VuZCIsInJlbmRlckxhYmVsIiwib2JqIiwibGFiZWxJbnB1dCIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImZvciIsImdldEVsZW1lbnRzQnlUYWdOYW1lIiwiaWQiLCJ0ZXh0Q29udGVudCIsImFwcGVuZENoaWxkIiwibW9iaWxlRm9ybWF0IiwiYXJyIiwic3RyIiwiYWNjIiwiaXRlbSIsImtleSIsInJlcyIsInJlbmRlckRyb3BEb3duTGlzdCIsIlNvcnRlZEZsYWdzIiwiaW5wdXRNb2JpbGVEZWZhdWx0IiwiaW5wdXRDb3VudHJ5Q29kZURlZmF1bHQiLCJoaWRkZW5JbnB1dE5hbWUiLCJib3JkZXJTdHlsZSIsImRyb3BEb3duSGVhZGVyIiwiZHJvcERvd25JbnB1dCIsImRyb3BEb3duTGlzdCIsImRyb3BEb3duSGlkZGVuSW5wdXQiLCJkcm9wRG93bkFycm93IiwiY2xhc3NOYW1lIiwibmFtZSIsInJlYWRPbmx5IiwicGxhY2Vob2xkZXIiLCJtYXhMZW5ndGgiLCJ2YWx1ZSIsInR5cGUiLCJ1bCIsImVsIiwibGkiLCJpbWdGbGFnIiwibGlUZXh0IiwibW9iaWxlX2NvZGUiLCJzdHlsZSIsImJhY2tncm91bmRJbWFnZSIsImZsYWdfcGljdHVyZV9uYW1lIiwidGl0bGUiLCJuYW1lX2N5ciIsImFkZEV2ZW50TGlzdGVuZXIiLCJkaXNwbGF5IiwibW9iaWxlSW5wdXQiLCJwYXR0ZXJuIiwicmVxdWlyZWQiLCJhdXRvY29tcGxldGUiLCJIaWRkZW5JbnB1dEhhbmRsZXIiLCJrZXlidWYiLCJzcGxpdCIsImNvbnNvbGUiLCJ3YXJuIiwiZSIsImxvZyIsImlzTmFOIiwicGFyc2VJbnQiLCJwcmV2ZW50RGVmYXVsdCIsImxlbmd0aCIsInBvcCIsInB1c2giLCJ1cFVzZWRDb3VudHJ5IiwiY29kZXMiLCJjb3VudHJpZXMiLCJ1cExpc3QiLCJmaWx0ZXIiLCJpbmNsdWRlcyIsIm5hbWVfbGF0IiwiY29uY2F0IiwiZm9ybWF0Q29kZXMiLCJzb3J0QXJyIiwibW9iaWxlX2NvZGVzIiwibyIsInJlbmRlck1vYmlsZUlucHV0IiwiY29uZmlnIiwidGhlbiIsIk1vYmlsZUNvZGVzIiwiU29ydGVkTW9iaWxlQ29kZXMiLCJkb21PYmplY3QiLCJkZWZhdWx0TW9iaWxlIiwiZGVmYXVsdENvdW50cnlDb2RlIiwiY2F0Y2giLCJlcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUlBLElBQU1BLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUNDLEdBQUQsRUFBUztBQUMzQjtBQUNBLE1BQU1DLEtBQUssR0FBRyxJQUFJQyxjQUFKLEVBQWQ7QUFFQSxNQUFNQyxHQUFHLEdBQUcsSUFBSUMsT0FBSixDQUFhLFVBQUNDLE9BQUQsRUFBVUMsTUFBVixFQUFxQjtBQUM1Q0wsSUFBQUEsS0FBSyxDQUFDTSxrQkFBTixHQUEyQixZQUFZO0FBQ3JDLFVBQUksS0FBS0MsVUFBTCxLQUFvQixDQUFwQixJQUF5QixLQUFLQyxNQUFMLEtBQWdCLEdBQTdDLEVBQWtEO0FBQUU7QUFDbEQsWUFBTUMsTUFBTSxHQUFHVCxLQUFLLENBQUNVLFlBQXJCO0FBQ0FOLFFBQUFBLE9BQU8sQ0FBQ08sSUFBSSxDQUFDQyxLQUFMLENBQVdILE1BQVgsQ0FBRCxDQUFQO0FBQ0QsT0FIRCxNQUdPLElBQUksS0FBS0YsVUFBTCxLQUFvQixDQUFwQixJQUF5QixLQUFLQyxNQUFMLEtBQWdCLEdBQTdDLEVBQWtEO0FBQ3ZESCxRQUFBQSxNQUFNLENBQUMsSUFBSVEsS0FB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TyxHQUFHLG9CQUFPL0QsR0FBRyxDQUFDZ0UsWUFBWCxFQUF5QixDQUFDLFVBQUNDLENBQUQ7QUFBQSxXQUFPQSxDQUFDLENBQUNwQyxXQUFUO0FBQUEsR0FBRCxDQUF6QixDQUFoQjtBQUNBLFNBQU95QixhQUFhLENBQUNTLE9BQUQsRUFBVSxDQUFDLFFBQUQsQ0FBVixDQUFwQjtBQUNELENBSEQ7O0FBS0EsSUFBTUcsaUJBQWlCLEdBQUcsU0FBcEJBLGlCQUFvQixDQUFDQyxNQUFELEVBQVk7QUFDcENqRyxFQUFBQSxXQUFXLENBQUNpRyxNQUFNLENBQUNoRyxHQUFSLENBQVgsQ0FDR2lHLElBREgsQ0FDUSxVQUFDQyxXQUFELEVBQWlCO0FBQ3JCLFFBQU1DLGlCQUFpQixHQUFHUixXQUFXLENBQUNPLFdBQUQsQ0FBckM7QUFDQWhGLElBQUFBLFdBQVcsQ0FBQzhFLE1BQU0sQ0FBQ0ksU0FBUixDQUFYO0FBQ0FqRSxJQUFBQSxrQkFBa0IsQ0FDaEI2RCxNQUFNLENBQUNJLFNBRFMsRUFFaEJELGlCQUZnQixFQUdoQkgsTUFBTSxDQUFDSyxhQUhTLEVBSWhCTCxNQUFNLENBQUNNLGtCQUpTLEVBS2hCTixNQUFNLENBQUN6RCxlQUxTLEVBTWhCeUQsTUFBTSxDQUFDeEQsV0FOUyxDQUFsQjtBQVFELEdBWkgsRUFhRytELEtBYkgsQ0FhUyxVQUFDQyxLQUFEO0FBQUEsV0FBVy9CLE9BQU8sQ0FBQ0csR0FBUixDQUFZNEIsS0FBWixDQUFYO0FBQUEsR0FiVDtBQWNBLFNBQU8sQ0FBUDtBQUNELENBaEJEOztlQWtCZVQsaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBmb3JFYWNoLCBzb3J0QnksIHJlZHVjZSxcbn0gZnJvbSAnbG9kYXNoJztcblxuY29uc3Qgc2VuZFJlcXVlc3QgPSAodXJsKSA9PiB7XG4gIC8qIGVzbGludC1kaXNhYmxlICovXG4gIGNvbnN0IHhodHRwID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG5cbiAgY29uc3QgcmVxID0gbmV3IFByb21pc2UoKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICB4aHR0cC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSA0ICYmIHRoaXMuc3RhdHVzID09PSAyMDApIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgICAgICBjb25zdCByZXN1bHQgPSB4aHR0cC5yZXNwb25zZVRleHQ7XG4gICAgICAgIHJlc29sdmUoSlNPTi5wYXJzZShyZXN1bHQpKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5yZWFkeVN0YXRlID09PSA0ICYmIHRoaXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgRXJyb3IhICR7dGhpcy5yZWFkeVN0YXRlfSAke3RoaXMuc3RhdHVzfWApKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHhodHRwLm9wZW4oJ1BPU1QnLCB1cmwsIHRydWUpO1xuICAgIHhodHRwLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtdHlwZScsICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnKTtcbiAgICB4aHR0cC5zZW5kKCdtb2JpbGVfY29kZXM9Z2V0Jyk7XG4gIH0pKTtcbiAgcmV0dXJuIHJlcTtcbiAgLyogZXNsaW50LWVuYWJsZSAqL1xufTtcblxuY29uc3QgcmVuZGVyTGFiZWwgPSAob2JqKSA9PiB7XG4gIGNvbnN0IGxhYmVsSW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsYWJlbCcpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gIGxhYmVsSW5wdXQuZm9yID0gb2JqLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbnB1dCcpLmlkO1xuICBsYWJlbElucHV0LnRleHRDb250ZW50ID0gJyArJztcbiAgb2JqLmFwcGVuZENoaWxkKGxhYmVsSW5wdXQpO1xuICByZXR1cm4gb2JqO1xufTtcblxuY29uc3QgbW9iaWxlRm9ybWF0ID0gKGFycikgPT4ge1xuICBjb25zdCBzdHIgPSByZWR1Y2UoYXJyLCAoYWNjLCBpdGVtLCBrZXkpID0+IHtcbiAgICBsZXQgcmVzID0gYWNjO1xuICAgIGlmIChrZXkgPT09IDIgfHwga2V5ID09PSA1KSB7XG4gICAgICByZXMgKz0gaXRlbTtcbiAgICAgIHJlcyArPSAnLSc7XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH1cbiAgICByZXMgKz0gaXRlbTtcbiAgICByZXR1cm4gcmVzO1xuICB9LCAnJyk7XG4gIHJldHVybiBzdHI7XG59O1xuXG5jb25zdCByZW5kZXJEcm9wRG93bkxpc3QgPSAob2JqLFxuICBTb3J0ZWRGbGFncyxcbiAgaW5wdXRNb2JpbGVEZWZhdWx0LFxuICBpbnB1dENvdW50cnlDb2RlRGVmYXVsdCxcbiAgaGlkZGVuSW5wdXROYW1lLFxuICBib3JkZXJTdHlsZSkgPT4ge1xuICBjb25zdCBkcm9wRG93bkhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICBjb25zdCBkcm9wRG93bklucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICBjb25zdCBkcm9wRG93bkxpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICBjb25zdCBkcm9wRG93bkhpZGRlbklucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICBjb25zdCBkcm9wRG93bkFycm93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcblxuICBkcm9wRG93bkxpc3QuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24tbGlzdCc7XG4gIGRyb3BEb3duSGVhZGVyLmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLWRyb3Bkb3duLWhlYWRlcic7XG4gIGlmIChib3JkZXJTdHlsZSA9PT0gJ3JlZCcpIHtcbiAgICBkcm9wRG93bklucHV0LmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLWRyb3Bkb3duLWlucHV0LXJlZCc7XG4gIH0gZWxzZSBpZiAoYm9yZGVyU3R5bGUgPT09ICdkZWZpbmUnKSB7XG4gICAgZHJvcERvd25JbnB1dC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1kcm9wZG93bi1pbnB1dCc7XG4gIH1cblxuXG4gIGRyb3BEb3duSW5wdXQubmFtZSA9ICdjb3VudHJ5X2NvZGUnO1xuICBkcm9wRG93bklucHV0LnJlYWRPbmx5ID0gdHJ1ZTtcbiAgZHJvcERvd25JbnB1dC5wbGFjZWhvbGRlciA9ICfQutC+0LQnO1xuICBkcm9wRG93bklucHV0Lm1heExlbmd0aCA9IDQ7XG4gIGRyb3BEb3duSW5wdXQudmFsdWUgPSBpbnB1dENvdW50cnlDb2RlRGVmYXVsdDtcblxuICBkcm9wRG93bkhpZGRlbklucHV0LnR5cGUgPSAnaGlkZGVuJztcbiAgZHJvcERvd25IaWRkZW5JbnB1dC5uYW1lID0gaGlkZGVuSW5wdXROYW1lIHx8ICdtb2JpbGVJbnB1dF9Nb2JpbGUnO1xuXG4gIGRyb3BEb3duSGVhZGVyLmFwcGVuZENoaWxkKGRyb3BEb3duSW5wdXQpO1xuXG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndWwnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICB1bC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1kcm9wZG93bi11bCc7XG5cbiAgZm9yRWFjaChTb3J0ZWRGbGFncywgKGVsKSA9PiB7XG4gICAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgbGV0IGltZ0ZsYWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgICBsZXQgbGlUZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgbGkuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24tbGknO1xuICAgIGltZ0ZsYWcuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24taW1nZmxhZyc7XG4gICAgbGlUZXh0LmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLWRyb3Bkb3duLWxpdGV4dCc7XG5cbiAgICBsaVRleHQudGV4dENvbnRlbnQgPSBlbC5tb2JpbGVfY29kZTtcblxuICAgIGltZ0ZsYWcuc3R5bGUuYmFja2dyb3VuZEltYWdlID0gYHVybCguLi9pbWcvZmxhZ3MvJHtlbC5mbGFnX3BpY3R1cmVfbmFtZX0pYDtcbiAgICAvLyBpbWdGbGFnLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9IGB1cmwoaW1nL2ZsYWdzLyR7ZWwuZmxhZ19waWN0dXJlX25hbWV9KWA7XG5cbiAgICBsaS5hcHBlbmRDaGlsZChpbWdGbGFnKTtcbiAgICBsaS5hcHBlbmRDaGlsZChsaVRleHQpO1xuXG4gICAgbGkudGl0bGUgPSBlbC5uYW1lX2N5cjtcbiAgICBsaS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgIGRyb3BEb3duSW5wdXQudmFsdWUgPSBsaVRleHQudGV4dENvbnRlbnQ7XG4gICAgICBkcm9wRG93bkxpc3Quc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICB9KTtcbiAgICB1bC5hcHBlbmRDaGlsZChsaSk7XG4gIH0pO1xuXG4gIGRyb3BEb3duTGlzdC5hcHBlbmRDaGlsZCh1bCk7XG5cbiAgY29uc3QgbW9iaWxlSW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gIGlmIChib3JkZXJTdHlsZSA9PT0gJ3JlZCcpIHtcbiAgICBtb2JpbGVJbnB1dC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1tb2JpbGUtaW5wdXQtcmVkJztcbiAgfSBlbHNlIGlmIChib3JkZXJTdHlsZSA9PT0gJ2RlZmluZScpIHtcbiAgICBtb2JpbGVJbnB1dC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1tb2JpbGUtaW5wdXQnO1xuICB9XG5cbiAgbW9iaWxlSW5wdXQucGF0dGVybiA9ICdcXFxcZHszfShcXFxcc3wtKVxcXFxkezN9KFxcXFxzfC0pXFxcXGR7NH0nO1xuICBtb2JpbGVJbnB1dC5wbGFjZWhvbGRlciA9ICdYWFgtWFhYLVhYWFgnO1xuICBtb2JpbGVJbnB1dC50aXRsZSA9ICfQvdC+0LzQtdGAINC80L7QsdC40LvRjNC90L7Qs9C+INGC0LXQu9C10YTQvtC90LAnO1xuICBtb2JpbGVJbnB1dC50eXBlID0gJ3RlbCc7XG4gIG1vYmlsZUlucHV0LnJlcXVpcmVkID0gdHJ1ZTtcbiAgbW9iaWxlSW5wdXQudmFsdWUgPSBtb2JpbGVGb3JtYXQoaW5wdXRNb2JpbGVEZWZhdWx0KTtcbiAgbW9iaWxlSW5wdXQubmFtZSA9ICdtb2JpbGVfbnVtYmVyJztcbiAgbW9iaWxlSW5wdXQuYXV0b2NvbXBsZXRlID0gJ29mZic7XG5cbiAgb2JqLmFwcGVuZENoaWxkKGRyb3BEb3duSGVhZGVyKTtcblxuICBkcm9wRG93bkhlYWRlci5hcHBlbmRDaGlsZChkcm9wRG93bkFycm93KTtcblxuICBvYmouYXBwZW5kQ2hpbGQobW9iaWxlSW5wdXQpO1xuXG4gIG9iai5hcHBlbmRDaGlsZChkcm9wRG93bkxpc3QpO1xuXG4gIGRyb3BEb3duSGlkZGVuSW5wdXQudmFsdWUgPSBtb2JpbGVGb3JtYXQoaW5wdXRNb2JpbGVEZWZhdWx0KTtcblxuICBvYmouYXBwZW5kQ2hpbGQoZHJvcERvd25IaWRkZW5JbnB1dCk7XG5cbiAgY29uc3QgSGlkZGVuSW5wdXRIYW5kbGVyID0gZnVuY3Rpb24gKCkge1xuICAgIGRyb3BEb3duSGlkZGVuSW5wdXQudmFsdWUgPSBkcm9wRG93bklucHV0LnZhbHVlICsgbW9iaWxlSW5wdXQudmFsdWU7XG4gICAgcmV0dXJuIGRyb3BEb3duSGlkZGVuSW5wdXQudmFsdWU7XG4gIH07XG5cbiAgY29uc3Qga2V5YnVmID0gaW5wdXRNb2JpbGVEZWZhdWx0LnNwbGl0KCcnKTtcbiAgY29uc29sZS53YXJuKCdpbnB1dE1vYmlsZURlZmF1bHQuc3BsaXQ6ICcsIGtleWJ1Zik7XG4gIC8vINC/0L4g0YPQvNC+0LvRh9Cw0L3QuNGOINCyINCx0YPRhNC10YAgKyDQvtCx0YDQsNCx0L7RgtC60LAg0L3QsNC20LDRgtC40Lkg0YHRgtGA0LXQu9C+0LpcbiAgbW9iaWxlSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHsgY29uc29sZS5sb2coZS5rZXkpOyB9KTtcbiAgbW9iaWxlSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7XG4gICAgaWYgKGlzTmFOKHBhcnNlSW50KGUua2V5LCAxMCkpICYmIGUua2V5ICE9PSAnQmFja3NwYWNlJyAmJiBlLmtleSAhPT0gJ0VudGVyJykgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChrZXlidWYubGVuZ3RoID49IDEwICYmIGUua2V5ICE9PSAnQmFja3NwYWNlJykge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoZS5rZXkgPT09ICdCYWNrc3BhY2UnKSB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBtb2JpbGVJbnB1dC52YWx1ZSA9ICcnO1xuICAgICAga2V5YnVmLnBvcCgpO1xuICAgICAgbW9iaWxlSW5wdXQudmFsdWUgPSBtb2JpbGVGb3JtYXQoa2V5YnVmKTtcbiAgICAgIEhpZGRlbklucHV0SGFuZGxlcigpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgbW9iaWxlSW5wdXQudmFsdWUgPSAnJztcbiAgICBrZXlidWYucHVzaChlLmtleSk7XG4gICAgbW9iaWxlSW5wdXQudmFsdWUgPSBtb2JpbGVGb3JtYXQoa2V5YnVmKTtcbiAgICBIaWRkZW5JbnB1dEhhbmRsZXIoKTtcbiAgfSk7XG5cbiAgZHJvcERvd25MaXN0LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCAoKSA9PiB7XG4gICAgZHJvcERvd25MaXN0LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgSGlkZGVuSW5wdXRIYW5kbGVyKCk7XG4gIH0pO1xuXG4gIGRyb3BEb3duSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgZHJvcERvd25MaXN0LnN0eWxlLmRpc3BsYXkgPSAoZHJvcERvd25MaXN0LnN0eWxlLmRpc3BsYXkgPT09ICdibG9jaycpID8gJ25vbmUnIDogJ2Jsb2NrJztcbiAgICBIaWRkZW5JbnB1dEhhbmRsZXIoKTtcbiAgfSk7XG5cbiAgZHJvcERvd25BcnJvdy5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1kcm9wZG93bi1oZWFkZXItYXJyb3cnO1xuICBkcm9wRG93bkFycm93LnRleHRDb250ZW50ID0gJ+KWvCc7XG4gIGRyb3BEb3duQXJyb3cuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgZHJvcERvd25MaXN0LnN0eWxlLmRpc3BsYXkgPSAoZHJvcERvd25MaXN0LnN0eWxlLmRpc3BsYXkgPT09ICdibG9jaycpID8gJ25vbmUnIDogJ2Jsb2NrJztcbiAgICBIaWRkZW5JbnB1dEhhbmRsZXIoKTtcbiAgfSk7XG5cbiAgbW9iaWxlSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXNpbicsICgpID0+IHtcbiAgICBkcm9wRG93bkxpc3Quc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICBIaWRkZW5JbnB1dEhhbmRsZXIoKTtcbiAgfSk7XG5cbiAgcmV0dXJuIG9iajtcbn07XG5cbmNvbnN0IHVwVXNlZENvdW50cnkgPSAoY29kZXMsIGNvdW50cmllcykgPT4ge1xuICBjb25zdCB1cExpc3QgPSBjb2Rlcy5maWx0ZXIoKGVsKSA9PiBjb3VudHJpZXMuaW5jbHVkZXMoZWwubmFtZV9sYXQpKTtcbiAgY29uc3QgcmVzdWx0ID0gdXBMaXN0LmNvbmNhdChjb2Rlcyk7XG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5jb25zdCBmb3JtYXRDb2RlcyA9IChhcnIpID0+IHtcbiAgY29uc3Qgc29ydEFyciA9IHNvcnRCeShhcnIubW9iaWxlX2NvZGVzLCBbKG8pID0+IG8ubW9iaWxlX2NvZGVdKTtcbiAgcmV0dXJuIHVwVXNlZENvdW50cnkoc29ydEFyciwgWydSdXNzaWEnXSk7XG59O1xuXG5jb25zdCByZW5kZXJNb2JpbGVJbnB1dCA9IChjb25maWcpID0+IHtcbiAgc2VuZFJlcXVlc3QoY29uZmlnLnVybClcbiAgICAudGhlbigoTW9iaWxlQ29kZXMpID0+IHtcbiAgICAgIGNvbnN0IFNvcnRlZE1vYmlsZUNvZGVzID0gZm9ybWF0Q29kZXMoTW9iaWxlQ29kZXMpO1xuICAgICAgcmVuZGVyTGFiZWwoY29uZmlnLmRvbU9iamVjdCk7XG4gICAgICByZW5kZXJEcm9wRG93bkxpc3QoXG4gICAgICAgIGNvbmZpZy5kb21PYmplY3QsXG4gICAgICAgIFNvcnRlZE1vYmlsZUNvZGVzLFxuICAgICAgICBjb25maWcuZGVmYXVsdE1vYmlsZSxcbiAgICAgICAgY29uZmlnLmRlZmF1bHRDb3VudHJ5Q29kZSxcbiAgICAgICAgY29uZmlnLmhpZGRlbklucHV0TmFtZSxcbiAgICAgICAgY29uZmlnLmJvcmRlclN0eWxlLFxuICAgICAgKTtcbiAgICB9KVxuICAgIC5jYXRjaCgoZXJyb3IpID0+IGNvbnNvbGUubG9nKGVycm9yKSk7XG4gIHJldHVybiAwO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgcmVuZGVyTW9iaWxlSW5wdXQ7XG4iXX0=