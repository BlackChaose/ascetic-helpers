"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = require("lodash");

// todo validation function //html5 + html4 && IE 10/11 support;
// todo
var sendRequest = function sendRequest(url) {
  /* eslint-disable */
  var xhttp = new XMLHttpRequest();
  var req = new Promise(function (resolve, reject) {
    xhttp.onreadystatechange = function () {
      if (this.readyState === 4 && this.status === 200) {
        // eslint-disable-line
        var result = xhttp.responseText;
        resolve(JSON.parse(result));
      } else if (this.readyState === 4 && this.status !== 200) {
        reject(new Error("Error! ".concat(this.readyState, " ").concat(this.status)));
      }
    };

    xhttp.open('POST', url, true);
    xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xhttp.send('mobile_codes=get');
  });
  return req;
  /* eslint-enable */
};

var renderLabel = function renderLabel(obj) {
  var labelInput = document.createElement('label'); // eslint-disable-line

  labelInput.for = obj.getElementsByTagName('input').id;
  labelInput.textContent = ' +';
  obj.appendChild(labelInput);
  return obj;
};

var mobileFormat = function mobileFormat(arr) {
  var str = (0, _lodash.reduce)(arr, function (acc, item, key) {
    var res = acc;

    if (key === 2 || key === 5) {
      res += item;
      res += '-';
      return res;
    }

    res += item;
    return res;
  }, '');
  return str;
};

var renderDropDownList = function renderDropDownList(obj, SortedFlags, inputMobileDefault, inputCountryCodeDefault, hiddenInputName, borderStyle) {
  var dropDownHeader = document.createElement('span'); // eslint-disable-line

  var dropDownInput = document.createElement('input'); // eslint-disable-line

  var dropDownList = document.createElement('div'); // eslint-disable-line

  var dropDownHiddenInput = document.createElement('input'); // eslint-disable-line

  dropDownList.className = 'mobile_input--dropdown-list';
  dropDownHeader.className = 'mobile_input--dropdown-header';

  if (borderStyle === 'red') {
    dropDownInput.className = 'mobile_input--dropdown-input-red';
  } else if (borderStyle === 'define') {
    dropDownInput.className = 'mobile_input--dropdown-input';
  }

  dropDownInput.name = 'country_code';
  dropDownInput.readOnly = true;
  dropDownInput.placeholder = 'код';
  dropDownInput.maxLength = 4;
  dropDownInput.value = inputCountryCodeDefault;
  dropDownHiddenInput.type = 'hidden';
  dropDownHiddenInput.name = hiddenInputName || 'mobileInput_Mobile';
  dropDownHeader.appendChild(dropDownInput);
  var ul = document.createElement('ul'); // eslint-disable-line

  ul.className = 'mobile_input--dropdown-ul';
  (0, _lodash.forEach)(SortedFlags, function (el) {
    var li = document.createElement('li'); // eslint-disable-line

    var imgFlag = document.createElement('span'); // eslint-disable-line

    var liText = document.createElement('span'); // eslint-disable-line

    li.className = 'mobile_input--dropdown-li';
    imgFlag.className = 'mobile_input--dropdown-imgflag';
    liText.className = 'mobile_input--dropdown-litext';
    liText.textContent = el.mobile_code;
    imgFlag.style.backgroundImage = "url(../img/flags/".concat(el.flag_picture_name, ")"); // imgFlag.style.backgroundImage = `url(img/flags/${el.flag_picture_name})`;

    li.appendChild(imgFlag);
    li.appendChild(liText);
    li.title = el.name_cyr;
    li.addEventListener('click', function () {
      dropDownInput.value = liText.textContent;
      dropDownList.style.display = 'none';
    });
    ul.appendChild(li);
  });
  dropDownList.appendChild(ul);
  var mobileInput = document.createElement('input'); // eslint-disable-line

  if (borderStyle === 'red') {
    mobileInput.className = 'mobile_input--mobile-input-red';
  } else if (borderStyle === 'define') {
    mobileInput.className = 'mobile_input--mobile-input';
  }

  mobileInput.pattern = '\\d{3}(\\s|-)\\d{3}(\\s|-)\\d{4}';
  mobileInput.placeholder = 'XXX-XXX-XXXX';
  mobileInput.title = 'номер мобильного телефона';
  mobileInput.type = 'tel';
  mobileInput.required = true;
  mobileInput.value = mobileFormat(inputMobileDefault);
  mobileInput.name = 'mobile_number';
  mobileInput.autocomplete = 'off';
  obj.appendChild(dropDownHeader);
  obj.appendChild(mobileInput);
  obj.appendChild(dropDownList);
  dropDownHiddenInput.value = mobileFormat(inputMobileDefault);
  obj.appendChild(dropDownHiddenInput);

  var HiddenInputHandler = function HiddenInputHandler() {
    dropDownHiddenInput.value = dropDownInput.value + mobileInput.value;
    return dropDownHiddenInput.value;
  };

  var keybuf = inputMobileDefault.split('');
  console.warn('inputMobileDefault.split: ', keybuf); // fixme: доработать буфер - надо считывать значение !!!!
  // по умолчанию в буфер + обработка нажатий стрелок

  mobileInput.addEventListener('change', function (e) {
    console.log(e.key);
  });
  mobileInput.addEventListener('keydown', function (e) {
    if (isNaN(parseInt(e.key, 10)) && e.key !== 'Backspace' && e.key !== 'Enter') {
      // eslint-disable-line
      e.preventDefault();
      return;
    }

    if (keybuf.length >= 10 && e.key !== 'Backspace') {
      e.preventDefault();
      return;
    }

    if (e.key === 'Backspace') {
      e.preventDefault();
      mobileInput.value = '';
      keybuf.pop();
      mobileInput.value = mobileFormat(keybuf);
      HiddenInputHandler();
      return;
    }

    e.preventDefault();
    mobileInput.value = '';
    keybuf.push(e.key);
    mobileInput.value = mobileFormat(keybuf);
    HiddenInputHandler();
  });
  dropDownList.addEventListener('mouseleave', function () {
    dropDownList.style.display = 'none';
    HiddenInputHandler();
  });
  dropDownInput.addEventListener('click', function () {
    dropDownList.style.display = dropDownList.style.display === 'block' ? 'none' : 'block';
    HiddenInputHandler();
  });
  mobileInput.addEventListener('focusin', function () {
    dropDownList.style.display = 'none';
    HiddenInputHandler();
  });
  return obj;
};

var upUsedCountry = function upUsedCountry(codes, countries) {
  var upList = codes.filter(function (el) {
    return countries.includes(el.name_lat);
  });
  var result = upList.concat(codes);
  return result;
};

var formatCodes = function formatCodes(arr) {
  var sortArr = (0, _lodash.sortBy)(arr.mobile_codes, [function (o) {
    return o.name_cyr;
  }]);
  return upUsedCountry(sortArr, ['Russia', 'Belarus', 'Finland', 'Kazakhstan', 'Kyrgyzstan', 'Azerbaijan', 'Armenia', 'Moldova', 'Tajikistan', 'Uzbekistan']);
};

var renderMobileInput = function renderMobileInput(config) {
  sendRequest(config.url).then(function (MobileCodes) {
    var SortedMobileCodes = formatCodes(MobileCodes);
    renderLabel(config.domObject);
    renderDropDownList(config.domObject, SortedMobileCodes, config.defaultMobile, config.defaultCountryCode, config.hiddenInputName, config.borderStyle);
  }).catch(function (error) {
    return console.log(error);
  });
  return 0;
};

var _default = renderMobileInput;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2JpbGVJbnB1dENvbXBvbmVudC5qcyJdLCJuYW1lcyI6WyJzZW5kUmVxdWVzdCIsInVybCIsInhodHRwIiwiWE1MSHR0cFJlcXVlc3QiLCJyZXEiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIm9ucmVhZHlzdGF0ZWNoYW5nZSIsInJlYWR5U3RhdGUiLCJzdGF0dXMiLCJyZXN1bHQiLCJyZXNwb25zZVRleHQiLCJKU09OIiwicGFyc2UiLCJFcnJvciIsIm9wZW4iLCJzZXRSZXF1ZXN0SGVhZGVyIiwic2VuZCIsInJlbmRlckxhYmVsIiwib2JqIiwibGFiZWxJbnB1dCIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImZvciIsImdldEVsZW1lbnRzQnlUYWdOYW1lIiwiaWQiLCJ0ZXh0Q29udGVudCIsImFwcGVuZENoaWxkIiwibW9iaWxlRm9ybWF0IiwiYXJyIiwic3RyIiwiYWNjIiwiaXRlbSIsImtleSIsInJlcyIsInJlbmRlckRyb3BEb3duTGlzdCIsIlNvcnRlZEZsYWdzIiwiaW5wdXRNb2JpbGVEZWZhdWx0IiwiaW5wdXRDb3VudHJ5Q29kZURlZmF1bHQiLCJoaWRkZW5JbnB1dE5hbWUiLCJib3JkZXJTdHlsZSIsImRyb3BEb3duSGVhZGVyIiwiZHJvcERvd25JbnB1dCIsImRyb3BEb3duTGlzdCIsImRyb3BEb3duSGlkZGVuSW5wdXQiLCJjbGFzc05hbWUiLCJuYW1lIiwicmVhZE9ubHkiLCJwbGFjZWhvbGRlciIsIm1heExlbmd0aCIsInZhbHVlIiwidHlwZSIsInVsIiwiZWwiLCJsaSIsImltZ0ZsYWciLCJsaVRleHQiLCJtb2JpbGVfY29kZSIsInN0eWxlIiwiYmFja2dyb3VuZEltYWdlIiwiZmxhZ19waWN0dXJlX25hbWUiLCJ0aXRsZSIsIm5hbWVfY3lyIiwiYWRkRXZlbnRMaXN0ZW5lciIsImRpc3BsYXkiLCJtb2JpbGVJbnB1dCIsInBhdHRlcm4iLCJyZXF1aXJlZCIsImF1dG9jb21wbGV0ZSIsIkhpZGRlbklucHV0SGFuZGxlciIsImtleWJ1ZiIsInNwbGl0IiwiY29uc29sZSIsIndhcm4iLCJlIiwibG9nIiwiaXNOYU4iLCJwYXJzZUludCIsInByZXZlbnREZWZhdWx0IiwibGVuZ3RoIiwicG9wIiwicHVzaCIsInVwVXNlZENvdW50cnkiLCJjb2RlcyIsImNvdW50cmllcyIsInVwTGlzdCIsImZpbHRlciIsImluY2x1ZGVzIiwibmFtZV9sYXQiLCJjb25jYXQiLCJmb3JtYXRDb2RlcyIsInNvcnRBcnIiLCJtb2JpbGVfY29kZXMiLCJvIiwicmVuZGVyTW9iaWxlSW5wdXQiLCJjb25maWciLCJ0aGVuIiwiTW9iaWxlQ29kZXMiLCJTb3J0ZWRNb2JpbGVDb2RlcyIsImRvbU9iamVjdCIsImRlZmF1bHRNb2JpbGUiLCJkZWZhdWx0Q291bnRyeUNvZGUiLCJjYXRjaCIsImVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBSUE7QUFDQTtBQUNBLElBQU1BLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUNDLEdBQUQsRUFBUztBQUMzQjtBQUNBLE1BQU1DLEtBQUssR0FBRyxJQUFJQyxjQUFKLEVBQWQ7QUFFQSxNQUFNQyxHQUFHLEdBQUcsSUFBSUMsT0FBSixDQUFhLFVBQUNDLE9BQUQsRUFBVUMsTUFBVixFQUFxQjtBQUM1Q0wsSUFBQUEsS0FBSyxDQUFDTSxrQkFBTixHQUEyQixZQUFZO0FBQ3JDLFVBQUksS0FBS0MsVUFBTCxLQUFvQixDQUFwQixJQUF5QixLQUFLQyxNQUFMLEtBQWdCLEdBQTdDLEVBQWtEO0FBQUU7QUFDbEQsWUFBTUMsTUFBTSxHQUFHVCxLQUFLLENBQUNVLFlBQXJCO0FBQ0FOLFFBQUFBLE9BQU8sQ0FBQ08sSUFBSSxDQUFDQyxLQUFMLENBQVdILE1BQVgsQ0FBRCxDQUFQO0FBQ0QsT0FIRCxNQUdPLElBQUksS0FBS0YsVUFBTCxLQUFvQixDQUFwQixJQUF5QixLQUFLQyxNQUFMLEtBQWdCLEdBQTdDLEVBQWtEO0FBQ3ZESCxRQUFBQSxNQUFNLENBQUMsSUFBSVEsS0FBSixrQkFB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QUFpQjtBQUNyQixRQUFNQyxpQkFBaUIsR0FBR1IsV0FBVyxDQUFDTyxXQUFELENBQXJDO0FBQ0EvRSxJQUFBQSxXQUFXLENBQUM2RSxNQUFNLENBQUNJLFNBQVIsQ0FBWDtBQUNBaEUsSUFBQUEsa0JBQWtCLENBQ2hCNEQsTUFBTSxDQUFDSSxTQURTLEVBRWhCRCxpQkFGZ0IsRUFHaEJILE1BQU0sQ0FBQ0ssYUFIUyxFQUloQkwsTUFBTSxDQUFDTSxrQkFKUyxFQUtoQk4sTUFBTSxDQUFDeEQsZUFMUyxFQU1oQndELE1BQU0sQ0FBQ3ZELFdBTlMsQ0FBbEI7QUFRRCxHQVpILEVBYUc4RCxLQWJILENBYVMsVUFBQ0MsS0FBRDtBQUFBLFdBQVcvQixPQUFPLENBQUNHLEdBQVIsQ0FBWTRCLEtBQVosQ0FBWDtBQUFBLEdBYlQ7QUFjQSxTQUFPLENBQVA7QUFDRCxDQWhCRDs7ZUFrQmVULGlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgZm9yRWFjaCwgc29ydEJ5LCByZWR1Y2UsXG59IGZyb20gJ2xvZGFzaCc7XG5cbi8vIHRvZG8gdmFsaWRhdGlvbiBmdW5jdGlvbiAvL2h0bWw1ICsgaHRtbDQgJiYgSUUgMTAvMTEgc3VwcG9ydDtcbi8vIHRvZG9cbmNvbnN0IHNlbmRSZXF1ZXN0ID0gKHVybCkgPT4ge1xuICAvKiBlc2xpbnQtZGlzYWJsZSAqL1xuICBjb25zdCB4aHR0cCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuXG4gIGNvbnN0IHJlcSA9IG5ldyBQcm9taXNlKCgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgeGh0dHAub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkge1xuICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gNCAmJiB0aGlzLnN0YXR1cyA9PT0gMjAwKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgICAgICAgY29uc3QgcmVzdWx0ID0geGh0dHAucmVzcG9uc2VUZXh0O1xuICAgICAgICByZXNvbHZlKEpTT04ucGFyc2UocmVzdWx0KSk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gNCAmJiB0aGlzLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoYEVycm9yISAke3RoaXMucmVhZHlTdGF0ZX0gJHt0aGlzLnN0YXR1c31gKSk7XG4gICAgICB9XG4gICAgfTtcbiAgICB4aHR0cC5vcGVuKCdQT1NUJywgdXJsLCB0cnVlKTtcbiAgICB4aHR0cC5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyk7XG4gICAgeGh0dHAuc2VuZCgnbW9iaWxlX2NvZGVzPWdldCcpO1xuICB9KSk7XG4gIHJldHVybiByZXE7XG4gIC8qIGVzbGludC1lbmFibGUgKi9cbn07XG5cbmNvbnN0IHJlbmRlckxhYmVsID0gKG9iaikgPT4ge1xuICBjb25zdCBsYWJlbElucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGFiZWwnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICBsYWJlbElucHV0LmZvciA9IG9iai5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW5wdXQnKS5pZDtcbiAgbGFiZWxJbnB1dC50ZXh0Q29udGVudCA9ICcgKyc7XG4gIG9iai5hcHBlbmRDaGlsZChsYWJlbElucHV0KTtcbiAgcmV0dXJuIG9iajtcbn07XG5cbmNvbnN0IG1vYmlsZUZvcm1hdCA9IChhcnIpID0+IHtcbiAgY29uc3Qgc3RyID0gcmVkdWNlKGFyciwgKGFjYywgaXRlbSwga2V5KSA9PiB7XG4gICAgbGV0IHJlcyA9IGFjYztcbiAgICBpZiAoa2V5ID09PSAyIHx8IGtleSA9PT0gNSkge1xuICAgICAgcmVzICs9IGl0ZW07XG4gICAgICByZXMgKz0gJy0nO1xuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG4gICAgcmVzICs9IGl0ZW07XG4gICAgcmV0dXJuIHJlcztcbiAgfSwgJycpO1xuICByZXR1cm4gc3RyO1xufTtcblxuY29uc3QgcmVuZGVyRHJvcERvd25MaXN0ID0gKG9iaixcbiAgU29ydGVkRmxhZ3MsXG4gIGlucHV0TW9iaWxlRGVmYXVsdCxcbiAgaW5wdXRDb3VudHJ5Q29kZURlZmF1bHQsXG4gIGhpZGRlbklucHV0TmFtZSxcbiAgYm9yZGVyU3R5bGUpID0+IHtcbiAgY29uc3QgZHJvcERvd25IZWFkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgY29uc3QgZHJvcERvd25JbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgY29uc3QgZHJvcERvd25MaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgY29uc3QgZHJvcERvd25IaWRkZW5JbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcblxuICBkcm9wRG93bkxpc3QuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24tbGlzdCc7XG4gIGRyb3BEb3duSGVhZGVyLmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLWRyb3Bkb3duLWhlYWRlcic7XG4gIGlmIChib3JkZXJTdHlsZSA9PT0gJ3JlZCcpIHtcbiAgICBkcm9wRG93bklucHV0LmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLWRyb3Bkb3duLWlucHV0LXJlZCc7XG4gIH0gZWxzZSBpZiAoYm9yZGVyU3R5bGUgPT09ICdkZWZpbmUnKSB7XG4gICAgZHJvcERvd25JbnB1dC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1kcm9wZG93bi1pbnB1dCc7XG4gIH1cblxuXG4gIGRyb3BEb3duSW5wdXQubmFtZSA9ICdjb3VudHJ5X2NvZGUnO1xuICBkcm9wRG93bklucHV0LnJlYWRPbmx5ID0gdHJ1ZTtcbiAgZHJvcERvd25JbnB1dC5wbGFjZWhvbGRlciA9ICfQutC+0LQnO1xuICBkcm9wRG93bklucHV0Lm1heExlbmd0aCA9IDQ7XG4gIGRyb3BEb3duSW5wdXQudmFsdWUgPSBpbnB1dENvdW50cnlDb2RlRGVmYXVsdDtcblxuICBkcm9wRG93bkhpZGRlbklucHV0LnR5cGUgPSAnaGlkZGVuJztcbiAgZHJvcERvd25IaWRkZW5JbnB1dC5uYW1lID0gaGlkZGVuSW5wdXROYW1lIHx8ICdtb2JpbGVJbnB1dF9Nb2JpbGUnO1xuXG4gIGRyb3BEb3duSGVhZGVyLmFwcGVuZENoaWxkKGRyb3BEb3duSW5wdXQpO1xuXG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndWwnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICB1bC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1kcm9wZG93bi11bCc7XG5cbiAgZm9yRWFjaChTb3J0ZWRGbGFncywgKGVsKSA9PiB7XG4gICAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgbGV0IGltZ0ZsYWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgICBsZXQgbGlUZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgbGkuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24tbGknO1xuICAgIGltZ0ZsYWcuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24taW1nZmxhZyc7XG4gICAgbGlUZXh0LmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLWRyb3Bkb3duLWxpdGV4dCc7XG5cbiAgICBsaVRleHQudGV4dENvbnRlbnQgPSBlbC5tb2JpbGVfY29kZTtcblxuICAgIGltZ0ZsYWcuc3R5bGUuYmFja2dyb3VuZEltYWdlID0gYHVybCguLi9pbWcvZmxhZ3MvJHtlbC5mbGFnX3BpY3R1cmVfbmFtZX0pYDtcbiAgICAvLyBpbWdGbGFnLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9IGB1cmwoaW1nL2ZsYWdzLyR7ZWwuZmxhZ19waWN0dXJlX25hbWV9KWA7XG5cbiAgICBsaS5hcHBlbmRDaGlsZChpbWdGbGFnKTtcbiAgICBsaS5hcHBlbmRDaGlsZChsaVRleHQpO1xuXG4gICAgbGkudGl0bGUgPSBlbC5uYW1lX2N5cjtcbiAgICBsaS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgIGRyb3BEb3duSW5wdXQudmFsdWUgPSBsaVRleHQudGV4dENvbnRlbnQ7XG4gICAgICBkcm9wRG93bkxpc3Quc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICB9KTtcbiAgICB1bC5hcHBlbmRDaGlsZChsaSk7XG4gIH0pO1xuXG4gIGRyb3BEb3duTGlzdC5hcHBlbmRDaGlsZCh1bCk7XG5cbiAgY29uc3QgbW9iaWxlSW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gIGlmIChib3JkZXJTdHlsZSA9PT0gJ3JlZCcpIHtcbiAgICBtb2JpbGVJbnB1dC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1tb2JpbGUtaW5wdXQtcmVkJztcbiAgfSBlbHNlIGlmIChib3JkZXJTdHlsZSA9PT0gJ2RlZmluZScpIHtcbiAgICBtb2JpbGVJbnB1dC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1tb2JpbGUtaW5wdXQnO1xuICB9XG5cbiAgbW9iaWxlSW5wdXQucGF0dGVybiA9ICdcXFxcZHszfShcXFxcc3wtKVxcXFxkezN9KFxcXFxzfC0pXFxcXGR7NH0nO1xuICBtb2JpbGVJbnB1dC5wbGFjZWhvbGRlciA9ICdYWFgtWFhYLVhYWFgnO1xuICBtb2JpbGVJbnB1dC50aXRsZSA9ICfQvdC+0LzQtdGAINC80L7QsdC40LvRjNC90L7Qs9C+INGC0LXQu9C10YTQvtC90LAnO1xuICBtb2JpbGVJbnB1dC50eXBlID0gJ3RlbCc7XG4gIG1vYmlsZUlucHV0LnJlcXVpcmVkID0gdHJ1ZTtcbiAgbW9iaWxlSW5wdXQudmFsdWUgPSBtb2JpbGVGb3JtYXQoaW5wdXRNb2JpbGVEZWZhdWx0KTtcbiAgbW9iaWxlSW5wdXQubmFtZSA9ICdtb2JpbGVfbnVtYmVyJztcbiAgbW9iaWxlSW5wdXQuYXV0b2NvbXBsZXRlID0gJ29mZic7XG5cbiAgb2JqLmFwcGVuZENoaWxkKGRyb3BEb3duSGVhZGVyKTtcblxuICBvYmouYXBwZW5kQ2hpbGQobW9iaWxlSW5wdXQpO1xuXG4gIG9iai5hcHBlbmRDaGlsZChkcm9wRG93bkxpc3QpO1xuXG4gIGRyb3BEb3duSGlkZGVuSW5wdXQudmFsdWUgPSBtb2JpbGVGb3JtYXQoaW5wdXRNb2JpbGVEZWZhdWx0KTtcblxuICBvYmouYXBwZW5kQ2hpbGQoZHJvcERvd25IaWRkZW5JbnB1dCk7XG5cbiAgY29uc3QgSGlkZGVuSW5wdXRIYW5kbGVyID0gZnVuY3Rpb24gKCkge1xuICAgIGRyb3BEb3duSGlkZGVuSW5wdXQudmFsdWUgPSBkcm9wRG93bklucHV0LnZhbHVlICsgbW9iaWxlSW5wdXQudmFsdWU7XG4gICAgcmV0dXJuIGRyb3BEb3duSGlkZGVuSW5wdXQudmFsdWU7XG4gIH07XG5cbiAgY29uc3Qga2V5YnVmID0gaW5wdXRNb2JpbGVEZWZhdWx0LnNwbGl0KCcnKTtcbiAgY29uc29sZS53YXJuKCdpbnB1dE1vYmlsZURlZmF1bHQuc3BsaXQ6ICcsIGtleWJ1Zik7XG4gIC8vIGZpeG1lOiDQtNC+0YDQsNCx0L7RgtCw0YLRjCDQsdGD0YTQtdGAIC0g0L3QsNC00L4g0YHRh9C40YLRi9Cy0LDRgtGMINC30L3QsNGH0LXQvdC40LUgISEhIVxuICAvLyDQv9C+INGD0LzQvtC70YfQsNC90LjRjiDQsiDQsdGD0YTQtdGAICsg0L7QsdGA0LDQsdC+0YLQutCwINC90LDQttCw0YLQuNC5INGB0YLRgNC10LvQvtC6XG4gIG1vYmlsZUlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7IGNvbnNvbGUubG9nKGUua2V5KTsgfSk7XG4gIG1vYmlsZUlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4ge1xuICAgIGlmIChpc05hTihwYXJzZUludChlLmtleSwgMTApKSAmJiBlLmtleSAhPT0gJ0JhY2tzcGFjZScgJiYgZS5rZXkgIT09ICdFbnRlcicpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoa2V5YnVmLmxlbmd0aCA+PSAxMCAmJiBlLmtleSAhPT0gJ0JhY2tzcGFjZScpIHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGUua2V5ID09PSAnQmFja3NwYWNlJykge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgbW9iaWxlSW5wdXQudmFsdWUgPSAnJztcbiAgICAgIGtleWJ1Zi5wb3AoKTtcbiAgICAgIG1vYmlsZUlucHV0LnZhbHVlID0gbW9iaWxlRm9ybWF0KGtleWJ1Zik7XG4gICAgICBIaWRkZW5JbnB1dEhhbmRsZXIoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIG1vYmlsZUlucHV0LnZhbHVlID0gJyc7XG4gICAga2V5YnVmLnB1c2goZS5rZXkpO1xuICAgIG1vYmlsZUlucHV0LnZhbHVlID0gbW9iaWxlRm9ybWF0KGtleWJ1Zik7XG4gICAgSGlkZGVuSW5wdXRIYW5kbGVyKCk7XG4gIH0pO1xuXG4gIGRyb3BEb3duTGlzdC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgKCkgPT4ge1xuICAgIGRyb3BEb3duTGlzdC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgIEhpZGRlbklucHV0SGFuZGxlcigpO1xuICB9KTtcblxuICBkcm9wRG93bklucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgIGRyb3BEb3duTGlzdC5zdHlsZS5kaXNwbGF5ID0gKGRyb3BEb3duTGlzdC5zdHlsZS5kaXNwbGF5ID09PSAnYmxvY2snKSA/ICdub25lJyA6ICdibG9jayc7XG4gICAgSGlkZGVuSW5wdXRIYW5kbGVyKCk7XG4gIH0pO1xuXG4gIG1vYmlsZUlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2ZvY3VzaW4nLCAoKSA9PiB7XG4gICAgZHJvcERvd25MaXN0LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgSGlkZGVuSW5wdXRIYW5kbGVyKCk7XG4gIH0pO1xuXG4gIHJldHVybiBvYmo7XG59O1xuXG5jb25zdCB1cFVzZWRDb3VudHJ5ID0gKGNvZGVzLCBjb3VudHJpZXMpID0+IHtcbiAgY29uc3QgdXBMaXN0ID0gY29kZXMuZmlsdGVyKChlbCkgPT4gY291bnRyaWVzLmluY2x1ZGVzKGVsLm5hbWVfbGF0KSk7XG4gIGNvbnN0IHJlc3VsdCA9IHVwTGlzdC5jb25jYXQoY29kZXMpO1xuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgZm9ybWF0Q29kZXMgPSAoYXJyKSA9PiB7XG4gIGNvbnN0IHNvcnRBcnIgPSBzb3J0QnkoYXJyLm1vYmlsZV9jb2RlcywgWyhvKSA9PiBvLm5hbWVfY3lyXSk7XG4gIHJldHVybiB1cFVzZWRDb3VudHJ5KHNvcnRBcnIsIFsnUnVzc2lhJywgJ0JlbGFydXMnLCAnRmlubGFuZCcsICdLYXpha2hzdGFuJywgJ0t5cmd5enN0YW4nLCAnQXplcmJhaWphbicsICdBcm1lbmlhJywgJ01vbGRvdmEnLCAnVGFqaWtpc3RhbicsICdVemJla2lzdGFuJ10pO1xufTtcblxuY29uc3QgcmVuZGVyTW9iaWxlSW5wdXQgPSAoY29uZmlnKSA9PiB7XG4gIHNlbmRSZXF1ZXN0KGNvbmZpZy51cmwpXG4gICAgLnRoZW4oKE1vYmlsZUNvZGVzKSA9PiB7XG4gICAgICBjb25zdCBTb3J0ZWRNb2JpbGVDb2RlcyA9IGZvcm1hdENvZGVzKE1vYmlsZUNvZGVzKTtcbiAgICAgIHJlbmRlckxhYmVsKGNvbmZpZy5kb21PYmplY3QpO1xuICAgICAgcmVuZGVyRHJvcERvd25MaXN0KFxuICAgICAgICBjb25maWcuZG9tT2JqZWN0LFxuICAgICAgICBTb3J0ZWRNb2JpbGVDb2RlcyxcbiAgICAgICAgY29uZmlnLmRlZmF1bHRNb2JpbGUsXG4gICAgICAgIGNvbmZpZy5kZWZhdWx0Q291bnRyeUNvZGUsXG4gICAgICAgIGNvbmZpZy5oaWRkZW5JbnB1dE5hbWUsXG4gICAgICAgIGNvbmZpZy5ib3JkZXJTdHlsZSxcbiAgICAgICk7XG4gICAgfSlcbiAgICAuY2F0Y2goKGVycm9yKSA9PiBjb25zb2xlLmxvZyhlcnJvcikpO1xuICByZXR1cm4gMDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IHJlbmRlck1vYmlsZUlucHV0O1xuIl19