"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = require("lodash");

// todo validation function //html5 + html4 && IE 10/11 support;
// todo
const sendRequest = url => {
  /* eslint-disable */
  const xhttp = new XMLHttpRequest();
  const req = new Promise((resolve, reject) => {
    xhttp.onreadystatechange = function () {
      if (this.readyState === 4 && this.status === 200) {
        // eslint-disable-line
        const result = xhttp.responseText;
        resolve(JSON.parse(result));
      } else if (this.readyState === 4 && this.status !== 200) {
        reject(new Error(`Error! ${this.readyState} ${this.status}`));
      }
    };

    xhttp.open('POST', url, true);
    xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xhttp.send('mobile_codes=get');
  });
  return req;
  /* eslint-enable */
};

const renderLabel = obj => {
  const labelInput = document.createElement('label'); // eslint-disable-line

  labelInput.for = obj.getElementsByTagName('input').id;
  labelInput.textContent = ' +';
  obj.append(labelInput);
  return obj;
};

const mobileFormat = arr => {
  const str = (0, _lodash.reduce)(arr, (acc, item, key) => {
    let res = acc;

    if (key === 2 || key === 5) {
      res += item;
      res += '-';
      return res;
    }

    res += item;
    return res;
  }, '');
  return str;
};

const renderDropDownList = (obj, SortedFlags, inputMobileDefault, inputCountryCodeDefault, hiddenInputName, borderStyle) => {
  const dropDownHeader = document.createElement('span'); // eslint-disable-line

  const dropDownInput = document.createElement('input'); // eslint-disable-line

  const dropDownList = document.createElement('div'); // eslint-disable-line

  const dropDownHiddenInput = document.createElement('input'); // eslint-disable-line

  dropDownList.className = 'mobile_input--dropdown-list';
  dropDownHeader.className = 'mobile_input--dropdown-header';

  if (borderStyle === 'red') {
    dropDownInput.className = 'mobile_input--dropdown-input-red';
  } else if (borderStyle === 'define') {
    dropDownInput.className = 'mobile_input--dropdown-input';
  }

  dropDownInput.name = 'country_code';
  dropDownInput.readOnly = true;
  dropDownInput.placeholder = 'код';
  dropDownInput.maxLength = 4;
  dropDownInput.value = inputCountryCodeDefault;
  dropDownHiddenInput.type = 'hidden';
  dropDownHiddenInput.name = hiddenInputName || 'mobileInput_Mobile';
  dropDownHeader.append(dropDownInput);
  const ul = document.createElement('ul'); // eslint-disable-line

  ul.className = 'mobile_input--dropdown-ul';
  (0, _lodash.forEach)(SortedFlags, el => {
    const li = document.createElement('li'); // eslint-disable-line

    let imgFlag = document.createElement('span'); // eslint-disable-line

    let liText = document.createElement('span'); // eslint-disable-line

    li.className = 'mobile_input--dropdown-li';
    imgFlag.className = 'mobile_input--dropdown-imgflag';
    liText.className = 'mobile_input--dropdown-litext';
    liText.textContent = el.mobile_code;
    imgFlag.style.backgroundImage = `url(../img/flags/${el.flag_picture_name})`; // imgFlag.style.backgroundImage = `url(img/flags/${el.flag_picture_name})`;

    li.appendChild(imgFlag);
    li.appendChild(liText);
    li.title = el.name_cyr;
    li.addEventListener('click', () => {
      dropDownInput.value = liText.textContent;
      dropDownList.style.display = 'none';
    });
    ul.append(li);
  });
  dropDownList.append(ul);
  const mobileInput = document.createElement('input'); // eslint-disable-line

  if (borderStyle === 'red') {
    mobileInput.className = 'mobile_input--mobile-input-red';
  } else if (borderStyle === 'define') {
    mobileInput.className = 'mobile_input--mobile-input';
  }

  mobileInput.pattern = '\\d{3}(\\s|-)\\d{3}(\\s|-)\\d{4}';
  mobileInput.placeholder = 'XXX-XXX-XXXX';
  mobileInput.title = 'номер мобильного телефона';
  mobileInput.type = 'tel';
  mobileInput.required = true;
  mobileInput.value = mobileFormat(inputMobileDefault);
  mobileInput.name = 'mobile_number';
  mobileInput.autocomplete = 'off';
  obj.append(dropDownHeader);
  obj.append(mobileInput);
  obj.append(dropDownList);
  dropDownHiddenInput.value = mobileFormat(inputMobileDefault);
  obj.append(dropDownHiddenInput);

  const HiddenInputHandler = function () {
    dropDownHiddenInput.value = dropDownInput.value + mobileInput.value;
    return dropDownHiddenInput.value;
  };

  const keybuf = inputMobileDefault.split('');
  console.warn('inputMobileDefault.split: ', keybuf); // fixme: доработать буфер - надо считывать значение !!!!
  // по умолчанию в буфер + обработка нажатий стрелок

  mobileInput.addEventListener('change', e => {
    console.log(e.key);
  });
  mobileInput.addEventListener('keydown', e => {
    if (isNaN(parseInt(e.key, 10)) && e.key !== 'Backspace' && e.key !== 'Enter') {
      // eslint-disable-line
      e.preventDefault();
      return;
    }

    if (keybuf.length >= 10 && e.key !== 'Backspace') {
      e.preventDefault();
      return;
    }

    if (e.key === 'Backspace') {
      e.preventDefault();
      mobileInput.value = '';
      keybuf.pop();
      mobileInput.value = mobileFormat(keybuf);
      HiddenInputHandler();
      return;
    }

    e.preventDefault();
    mobileInput.value = '';
    keybuf.push(e.key);
    mobileInput.value = mobileFormat(keybuf);
    HiddenInputHandler();
  });
  dropDownList.addEventListener('mouseleave', () => {
    dropDownList.style.display = 'none';
    HiddenInputHandler();
  });
  dropDownInput.addEventListener('click', () => {
    dropDownList.style.display = dropDownList.style.display === 'block' ? 'none' : 'block';
    HiddenInputHandler();
  });
  mobileInput.addEventListener('focusin', () => {
    dropDownList.style.display = 'none';
    HiddenInputHandler();
  });
  return obj;
};

const upUsedCountry = (codes, countries) => {
  const upList = codes.filter(el => countries.includes(el.name_lat));
  const result = upList.concat(codes);
  return result;
};

const formatCodes = arr => {
  const sortArr = (0, _lodash.sortBy)(arr.mobile_codes, [o => o.name_cyr]);
  return upUsedCountry(sortArr, ['Russia', 'Belarus', 'Finland', 'Kazakhstan', 'Kyrgyzstan', 'Azerbaijan', 'Armenia', 'Moldova', 'Tajikistan', 'Uzbekistan']);
};

const renderMobileInput = config => {
  sendRequest(config.url).then(MobileCodes => {
    const SortedMobileCodes = formatCodes(MobileCodes);
    renderLabel(config.domObject);
    renderDropDownList(config.domObject, SortedMobileCodes, config.defaultMobile, config.defaultCountryCode, config.hiddenInputName, config.borderStyle);
  }).catch(error => console.log(error));
  return 0;
};

var _default = renderMobileInput;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2JpbGVJbnB1dENvbXBvbmVudC5qcyJdLCJuYW1lcyI6WyJzZW5kUmVxdWVzdCIsInVybCIsInhodHRwIiwiWE1MSHR0cFJlcXVlc3QiLCJyZXEiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIm9ucmVhZHlzdGF0ZWNoYW5nZSIsInJlYWR5U3RhdGUiLCJzdGF0dXMiLCJyZXN1bHQiLCJyZXNwb25zZVRleHQiLCJKU09OIiwicGFyc2UiLCJFcnJvciIsIm9wZW4iLCJzZXRSZXF1ZXN0SGVhZGVyIiwic2VuZCIsInJlbmRlckxhYmVsIiwib2JqIiwibGFiZWxJbnB1dCIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImZvciIsImdldEVsZW1lbnRzQnlUYWdOYW1lIiwiaWQiLCJ0ZXh0Q29udGVudCIsImFwcGVuZCIsIm1vYmlsZUZvcm1hdCIsImFyciIsInN0ciIsImFjYyIsIml0ZW0iLCJrZXkiLCJyZXMiLCJyZW5kZXJEcm9wRG93bkxpc3QiLCJTb3J0ZWRGbGFncyIsImlucHV0TW9iaWxlRGVmYXVsdCIsImlucHV0Q291bnRyeUNvZGVEZWZhdWx0IiwiaGlkZGVuSW5wdXROYW1lIiwiYm9yZGVyU3R5bGUiLCJkcm9wRG93bkhlYWRlciIsImRyb3BEb3duSW5wdXQiLCJkcm9wRG93bkxpc3QiLCJkcm9wRG93bkhpZGRlbklucHV0IiwiY2xhc3NOYW1lIiwibmFtZSIsInJlYWRPbmx5IiwicGxhY2Vob2xkZXIiLCJtYXhMZW5ndGgiLCJ2YWx1ZSIsInR5cGUiLCJ1bCIsImVsIiwibGkiLCJpbWdGbGFnIiwibGlUZXh0IiwibW9iaWxlX2NvZGUiLCJzdHlsZSIsImJhY2tncm91bmRJbWFnZSIsImZsYWdfcGljdHVyZV9uYW1lIiwiYXBwZW5kQ2hpbGQiLCJ0aXRsZSIsIm5hbWVfY3lyIiwiYWRkRXZlbnRMaXN0ZW5lciIsImRpc3BsYXkiLCJtb2JpbGVJbnB1dCIsInBhdHRlcm4iLCJyZXF1aXJlZCIsImF1dG9jb21wbGV0ZSIsIkhpZGRlbklucHV0SGFuZGxlciIsImtleWJ1ZiIsInNwbGl0IiwiY29uc29sZSIsIndhcm4iLCJlIiwibG9nIiwiaXNOYU4iLCJwYXJzZUludCIsInByZXZlbnREZWZhdWx0IiwibGVuZ3RoIiwicG9wIiwicHVzaCIsInVwVXNlZENvdW50cnkiLCJjb2RlcyIsImNvdW50cmllcyIsInVwTGlzdCIsImZpbHRlciIsImluY2x1ZGVzIiwibmFtZV9sYXQiLCJjb25jYXQiLCJmb3JtYXRDb2RlcyIsInNvcnRBcnIiLCJtb2JpbGVfY29kZXMiLCJvIiwicmVuZGVyTW9iaWxlSW5wdXQiLCJjb25maWciLCJ0aGVuIiwiTW9iaWxlQ29kZXMiLCJTb3J0ZWRNb2JpbGVDb2RlcyIsImRvbU9iamVjdCIsImRlZmF1bHRNb2JpbGUiLCJkZWZhdWx0Q291bnRyeUNvZGUiLCJjYXRjaCIsImVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBSUE7QUFDQTtBQUNBLE1BQU1BLFdBQVcsR0FBSUMsR0FBRCxJQUFTO0FBQzNCO0FBQ0EsUUFBTUMsS0FBSyxHQUFHLElBQUlDLGNBQUosRUFBZDtBQUVBLFFBQU1DLEdBQUcsR0FBRyxJQUFJQyxPQUFKLENBQWEsQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQzVDTCxJQUFBQSxLQUFLLENBQUNNLGtCQUFOLEdBQTJCLFlBQVk7QUFDckMsVUFBSSxLQUFLQyxVQUFMLEtBQW9CLENBQXBCLElBQXlCLEtBQUtDLE1BQUwsS0FBZ0IsR0FBN0MsRUFBa0Q7QUFBRTtBQUNsRCxjQUFNQyxNQUFNLEdBQUdULEtBQUssQ0FBQ1UsWUFBckI7QUFDQU4sUUFBQUEsT0FBTyxDQUFDTyxJQUFJLENBQUNDLEtBQUwsQ0FBV0gsTUFBWCxDQUFELENBQVA7QUFDRCxPQUhELE1BR08sSUFBSSxLQUFLRixVQUFMLEtBQW9CLENBQXBCLElBQXlCLEtBQUtDLE1BQUwsS0FBZ0IsR0FBN0MsRUFBa0Q7QUFDdkRILFFBQUFBLE1BQU0sQ0FBQyxJQUFJUSxLQUFKLENBQVcsVUFBUyxLQUFLTixVQUFXLElBQUcsS0FBS0MsTUFBTyxFQUFuRCxDQUFELENBQU47QUFDRDtBQUNGLEtBUEQ7O0FBUUFSLElBQUFBLEtBQUssQ0FBQ2MsSUFBTixDQUFXLE1BQVgsRUFBbUJmLEdBQW5CLEVBQXdCLElBQXhCO0FBQ0FDLElBQUFBLEtBQUssQ0FBQ2UsZ0JBQU4sQ0FBdUIsY0FBdkIsRUFBdUMsbUNBQXZDO0FBQ0FmLElBQUFBLEtBQUssQ0FBQ2dCLElBQU4sQ0FBVyxrQkFBWDtBQUNELEdBWlcsQ0FBWjtBQWFBLFNBQU9kLEdBQVA7QUFDQTtBQUNELENBbkJEOztBQXFCQSxNQUFNZSxXQUFXLEdBQUlDLEdBQUQsSUFBUztBQUMzQixRQUFNQyxVQUFVLEdBQUdDLFFBQVEsQ0FBQ0MsYUFBVCxDQUF1QixPQUF2QixDQUFuQixDQUQyQixDQUN5Qjs7QUFDcERGLEVBQUFBLFVBQVUsQ0FBQ0csR0FBWCxHQUFpQkosR0FBRyxDQUFDSyxvQkFBSixDQUF5QixPQUF6QixFQUFrQ0MsRUFBbkQ7QUFDQUwsRUFBQUEsVUFBVSxDQUFDTSxXQUFYLEdBQXlCLElBQXpCO0FBQ0FQLEVBQUFBLEdBQUcsQ0FBQ1EsTUFBSixDQUFXUCxVQUFYO0FBQ0EsU0FBT0QsR0FBUDtBQUNELENBTkQ7O0FBUUEsTUFBTVMsWUFBWSxHQUFJQyxHQUFELElBQVM7QUFDNUIsUUFBTUMsR0FBRyxHQUFHLG9CQUFPRCxHQUFQLEVBQVksQ0FBQ0UsR0FBRCxFQUFNQyxJQUFOLEVBQVlDLEdBQVosS0FBb0I7QUFDMUMsUUFBSUMsR0FBRyxHQUFHSCxHQUFWOztBQUNBLFFBQUlFLEdBQUcsS0FBSyxDQUFSLElBQWFBLEdBQUcsS0FBSyxDQUF6QixFQUE0QjtBQUMxQkMsTUFBQUEsR0FBRyxJQUFJRixJQUFQO0FBQ0FFLE1BQUFBLEdBQUcsSUFBSSxHQUFQO0FBQ0EsYUFBT0EsR0FBUDtBQUNEOztBQUNEQSxJQUFBQSxHQUFHLElBQUlGLElBQVA7QUFDQSxXQUFPRSxHQUFQO0FBQ0QsR0FUVyxFQVNULEVBVFMsQ0FBWjtBQVVBLFNBQU9KLEdBQVA7QUFDRCxDQVpEOztBQWNBLE1BQU1LLGtCQUFrQixHQUFHLENBQUNoQixHQUFELEVBQ3pCaUIsV0FEeUIsRUFFekJDLGtCQUZ5QixFQUd6QkMsdUJBSHlCLEVBSXpCQyxlQUp5QixFQUt6QkMsV0FMeUIsS0FLVDtBQUNoQixRQUFNQyxjQUFjLEdBQUdwQixRQUFRLENBQUNDLGFBQVQsQ0FBdUIsTUFBdkIsQ0FBdkIsQ0FEZ0IsQ0FDdUM7O0FBQ3ZELFFBQU1vQixhQUFhLEdBQUdyQixRQUFRLENBQUNDLGFBQVQsQ0FBdUIsT0FBdkIsQ0FBdEIsQ0FGZ0IsQ0FFdUM7O0FBQ3ZELFFBQU1xQixZQUFZLEdBQUd0QixRQUFRLENBQUNDLGFBQVQsQ0FBdUIsS0FBdkIsQ0FBckIsQ0FIZ0IsQ0FHb0M7O0FBQ3BELFFBQU1zQixtQkFBbUIsR0FBR3ZCLFFBQVEsQ0FBQ0MsYUFBVCxDQUF1QixPQUF2QixDQUE1QixDQUpnQixDQUk2Qzs7QUFFN0RxQixFQUFBQSxZQUFZLENBQUNFLFNBQWIsR0FBeUIsNkJBQXpCO0FBQ0FKLEVBQUFBLGNBQWMsQ0FBQ0ksU0FBZixHQUEyQiwrQkFBM0I7O0FBQ0EsTUFBSUwsV0FBVyxLQUFLLEtBQXBCLEVBQTJCO0FBQ3pCRSxJQUFBQSxhQUFhLENBQUNHLFNBQWQsR0FBMEIsa0NBQTFCO0FBQ0QsR0FGRCxNQUVPLElBQUlMLFdBQVcsS0FBSyxRQUFwQixFQUE4QjtBQUNuQ0UsSUFBQUEsYUFBYSxDQUFDRyxTQUFkLEdBQTBCLDhCQUExQjtBQUNEOztBQUdESCxFQUFBQSxhQUFhLENBQUNJLElBQWQsR0FBcUIsY0FBckI7QUFDQUosRUFBQUEsYUFBYSxDQUFDSyxRQUFkLEdBQXlCLElBQXpCO0FBQ0FMLEVBQUFBLGFBQWEsQ0FBQ00sV0FBZCxHQUE0QixLQUE1QjtBQUNBTixFQUFBQSxhQUFhLENBQUNPLFNBQWQsR0FBMEIsQ0FBMUI7QUFDQVAsRUFBQUEsYUFBYSxDQUFDUSxLQUFkLEdBQXNCWix1QkFBdEI7QUFFQU0sRUFBQUEsbUJBQW1CLENBQUNPLElBQXBCLEdBQTJCLFFBQTNCO0FBQ0FQLEVBQUFBLG1CQUFtQixDQUFDRSxJQUFwQixHQUEyQlAsZUFBZSxJQUFJLG9CQUE5QztBQUVBRSxFQUFBQSxjQUFjLENBQUNkLE1BQWYsQ0FBc0JlLGFBQXRCO0FBRUEsUUFBTVUsRUFBRSxHQUFHL0IsUUFBUSxDQUFDQyxhQUFULENBQXVCLElBQXZCLENBQVgsQ0ExQmdCLENBMEJ5Qjs7QUFDekM4QixFQUFBQSxFQUFFLENBQUNQLFNBQUgsR0FBZSwyQkFBZjtBQUVBLHVCQUFRVCxXQUFSLEVBQXNCaUIsRUFBRCxJQUFRO0FBQzNCLFVBQU1DLEVBQUUsR0FBR2pDLFFBQVEsQ0FBQ0MsYUFBVCxDQUF1QixJQUF2QixDQUFYLENBRDJCLENBQ2M7O0FBQ3pDLFFBQUlpQyxPQUFPLEdBQUdsQyxRQUFRLENBQUNDLGFBQVQsQ0FBdUIsTUFBdkIsQ0FBZCxDQUYyQixDQUVtQjs7QUFDOUMsUUFBSWtDLE1BQU0sR0FBR25DLFFBQVEsQ0FBQ0MsYUFBVCxDQUF1QixNQUF2QixDQUFiLENBSDJCLENBR2tCOztBQUM3Q2dDLElBQUFBLEVBQUUsQ0FBQ1QsU0FBSCxHQUFlLDJCQUFmO0FBQ0FVLElBQUFBLE9BQU8sQ0FBQ1YsU0FBUixHQUFvQixnQ0FBcEI7QUFDQVcsSUFBQUEsTUFBTSxDQUFDWCxTQUFQLEdBQW1CLCtCQUFuQjtBQUVBVyxJQUFBQSxNQUFNLENBQUM5QixXQUFQLEdBQXFCMkIsRUFBRSxDQUFDSSxXQUF4QjtBQUVBRixJQUFBQSxPQUFPLENBQUNHLEtBQVIsQ0FBY0MsZUFBZCxHQUFpQyxvQkFBbUJOLEVBQUUsQ0FBQ08saUJBQWtCLEdBQXpFLENBVjJCLENBVzNCOztBQUVBTixJQUFBQSxFQUFFLENBQUNPLFdBQUgsQ0FBZU4sT0FBZjtBQUNBRCxJQUFBQSxFQUFFLENBQUNPLFdBQUgsQ0FBZUwsTUFBZjtBQUVBRixJQUFBQSxFQUFFLENBQUNRLEtBQUgsR0FBV1QsRUFBRSxDQUFDVSxRQUFkO0FBQ0FULElBQUFBLEVBQUUsQ0FBQ1UsZ0JBQUgsQ0FBb0IsT0FBcEIsRUFBNkIsTUFBTTtBQUNqQ3RCLE1BQUFBLGFBQWEsQ0FBQ1EsS0FBZCxHQUFzQk0sTUFBTSxDQUFDOUIsV0FBN0I7QUFDQWlCLE1BQUFBLFlBQVksQ0FBQ2UsS0FBYixDQUFtQk8sT0FBbkIsR0FBNkIsTUFBN0I7QUFDRCxLQUhEO0FBSUFiLElBQUFBLEVBQUUsQ0FBQ3pCLE1BQUgsQ0FBVTJCLEVBQVY7QUFDRCxHQXRCRDtBQXdCQVgsRUFBQUEsWUFBWSxDQUFDaEIsTUFBYixDQUFvQnlCLEVBQXBCO0FBRUEsUUFBTWMsV0FBVyxHQUFHN0MsUUFBUSxDQUFDQyxhQUFULENBQXVCLE9BQXZCLENBQXBCLENBdkRnQixDQXVEcUM7O0FBQ3JELE1BQUlrQixXQUFXLEtBQUssS0FBcEIsRUFBMkI7QUFDekIwQixJQUFBQSxXQUFXLENBQUNyQixTQUFaLEdBQXdCLGdDQUF4QjtBQUNELEdBRkQsTUFFTyxJQUFJTCxXQUFXLEtBQUssUUFBcEIsRUFBOEI7QUFDbkMwQixJQUFBQSxXQUFXLENBQUNyQixTQUFaLEdBQXdCLDRCQUF4QjtBQUNEOztBQUVEcUIsRUFBQUEsV0FBVyxDQUFDQyxPQUFaLEdBQXNCLGtDQUF0QjtBQUNBRCxFQUFBQSxXQUFXLENBQUNsQixXQUFaLEdBQTBCLGNBQTFCO0FBQ0FrQixFQUFBQSxXQUFXLENBQUNKLEtBQVosR0FBb0IsMkJBQXBCO0FBQ0FJLEVBQUFBLFdBQVcsQ0FBQ2YsSUFBWixHQUFtQixLQUFuQjtBQUNBZSxFQUFBQSxXQUFXLENBQUNFLFFBQVosR0FBdUIsSUFBdkI7QUFDQUYsRUFBQUEsV0FBVyxDQUFDaEIsS0FBWixHQUFvQnRCLFlBQVksQ0FBQ1Msa0JBQUQsQ0FBaEM7QUFDQTZCLEVBQUFBLFdBQVcsQ0FBQ3BCLElBQVosR0FBbUIsZUFBbkI7QUFDQW9CLEVBQUFBLFdBQVcsQ0FBQ0csWUFBWixHQUEyQixLQUEzQjtBQUVBbEQsRUFBQUEsR0FBRyxDQUFDUSxNQUFKLENBQVdjLGNBQVg7QUFFQXRCLEVBQUFBLEdBQUcsQ0FBQ1EsTUFBSixDQUFXdUMsV0FBWDtBQUVBL0MsRUFBQUEsR0FBRyxDQUFDUSxNQUFKLENBQVdnQixZQUFYO0FBRUFDLEVBQUFBLG1CQUFtQixDQUFDTSxLQUFwQixHQUE0QnRCLFlBQVksQ0FBQ1Msa0JBQUQsQ0FBeEM7QUFFQWxCLEVBQUFBLEdBQUcsQ0FBQ1EsTUFBSixDQUFXaUIsbUJBQVg7O0FBRUEsUUFBTTBCLGtCQUFrQixHQUFHLFlBQVk7QUFDckMxQixJQUFBQSxtQkFBbUIsQ0FBQ00sS0FBcEIsR0FBNEJSLGFBQWEsQ0FBQ1EsS0FBZCxHQUFzQmdCLFdBQVcsQ0FBQ2hCLEtBQTlEO0FBQ0EsV0FBT04sbUJBQW1CLENBQUNNLEtBQTNCO0FBQ0QsR0FIRDs7QUFLQSxRQUFNcUIsTUFBTSxHQUFHbEMsa0JBQWtCLENBQUNtQyxLQUFuQixDQUF5QixFQUF6QixDQUFmO0FBQ0FDLEVBQUFBLE9BQU8sQ0FBQ0MsSUFBUixDQUFhLDRCQUFiLEVBQTJDSCxNQUEzQyxFQXZGZ0IsQ0F3RmhCO0FBQ0E7O0FBQ0FMLEVBQUFBLFdBQVcsQ0FBQ0YsZ0JBQVosQ0FBNkIsUUFBN0IsRUFBd0NXLENBQUQsSUFBTztBQUFFRixJQUFBQSxPQUFPLENBQUNHLEdBQVIsQ0FBWUQsQ0FBQyxDQUFDMUMsR0FBZDtBQUFxQixHQUFyRTtBQUNBaUMsRUFBQUEsV0FBVyxDQUFDRixnQkFBWixDQUE2QixTQUE3QixFQUF5Q1csQ0FBRCxJQUFPO0FBQzdDLFFBQUlFLEtBQUssQ0FBQ0MsUUFBUSxDQUFDSCxDQUFDLENBQUMxQyxHQUFILEVBQVEsRUFBUixDQUFULENBQUwsSUFBOEIwQyxDQUFDLENBQUMxQyxHQUFGLEtBQVUsV0FBeEMsSUFBdUQwQyxDQUFDLENBQUMxQyxHQUFGLEtBQVUsT0FBckUsRUFBOEU7QUFBRTtBQUM5RTBDLE1BQUFBLENBQUMsQ0FBQ0ksY0FBRjtBQUNBO0FBQ0Q7O0FBQ0QsUUFBSVIsTUFBTSxDQUFDUyxNQUFQLElBQWlCLEVBQWpCLElBQXVCTCxDQUFDLENBQUMxQyxHQUFGLEtBQVUsV0FBckMsRUFBa0Q7QUFDaEQwQyxNQUFBQSxDQUFDLENBQUNJLGNBQUY7QUFDQTtBQUNEOztBQUNELFFBQUlKLENBQUMsQ0FBQzFDLEdBQUYsS0FBVSxXQUFkLEVBQTJCO0FBQ3pCMEMsTUFBQUEsQ0FBQyxDQUFDSSxjQUFGO0FBQ0FiLE1BQUFBLFdBQVcsQ0FBQ2hCLEtBQVosR0FBb0IsRUFBcEI7QUFDQXFCLE1BQUFBLE1BQU0sQ0FBQ1UsR0FBUDtBQUNBZixNQUFBQSxXQUFXLENBQUNoQixLQUFaLEdBQW9CdEIsWUFBWSxDQUFDMkMsTUFBRCxDQUFoQztBQUNBRCxNQUFBQSxrQkFBa0I7QUFDbEI7QUFDRDs7QUFDREssSUFBQUEsQ0FBQyxDQUFDSSxjQUFGO0FBQ0FiLElBQUFBLFdBQVcsQ0FBQ2hCLEtBQVosR0FBb0IsRUFBcEI7QUFDQXFCLElBQUFBLE1BQU0sQ0FBQ1csSUFBUCxDQUFZUCxDQUFDLENBQUMxQyxHQUFkO0FBQ0FpQyxJQUFBQSxXQUFXLENBQUNoQixLQUFaLEdBQW9CdEIsWUFBWSxDQUFDMkMsTUFBRCxDQUFoQztBQUNBRCxJQUFBQSxrQkFBa0I7QUFDbkIsR0F0QkQ7QUF3QkEzQixFQUFBQSxZQUFZLENBQUNxQixnQkFBYixDQUE4QixZQUE5QixFQUE0QyxNQUFNO0FBQ2hEckIsSUFBQUEsWUFBWSxDQUFDZSxLQUFiLENBQW1CTyxPQUFuQixHQUE2QixNQUE3QjtBQUNBSyxJQUFBQSxrQkFBa0I7QUFDbkIsR0FIRDtBQUtBNUIsRUFBQUEsYUFBYSxDQUFDc0IsZ0JBQWQsQ0FBK0IsT0FBL0IsRUFBd0MsTUFBTTtBQUM1Q3JCLElBQUFBLFlBQVksQ0FBQ2UsS0FBYixDQUFtQk8sT0FBbkIsR0FBOEJ0QixZQUFZLENBQUNlLEtBQWIsQ0FBbUJPLE9BQW5CLEtBQStCLE9BQWhDLEdBQTJDLE1BQTNDLEdBQW9ELE9BQWpGO0FBQ0FLLElBQUFBLGtCQUFrQjtBQUNuQixHQUhEO0FBS0FKLEVBQUFBLFdBQVcsQ0FBQ0YsZ0JBQVosQ0FBNkIsU0FBN0IsRUFBd0MsTUFBTTtBQUM1Q3JCLElBQUFBLFlBQVksQ0FBQ2UsS0FBYixDQUFtQk8sT0FBbkIsR0FBNkIsTUFBN0I7QUFDQUssSUFBQUEsa0JBQWtCO0FBQ25CLEdBSEQ7QUFLQSxTQUFPbkQsR0FBUDtBQUNELENBeElEOztBQTBJQSxNQUFNZ0UsYUFBYSxHQUFHLENBQUNDLEtBQUQsRUFBUUMsU0FBUixLQUFzQjtBQUMxQyxRQUFNQyxNQUFNLEdBQUdGLEtBQUssQ0FBQ0csTUFBTixDQUFjbEMsRUFBRCxJQUFRZ0MsU0FBUyxDQUFDRyxRQUFWLENBQW1CbkMsRUFBRSxDQUFDb0MsUUFBdEIsQ0FBckIsQ0FBZjtBQUNBLFFBQU0vRSxNQUFNLEdBQUc0RSxNQUFNLENBQUNJLE1BQVAsQ0FBY04sS0FBZCxDQUFmO0FBQ0EsU0FBTzFFLE1BQVA7QUFDRCxDQUpEOztBQU1BLE1BQU1pRixXQUFXLEdBQUk5RCxHQUFELElBQVM7QUFDM0IsUUFBTStELE9BQU8sR0FBRyxvQkFBTy9ELEdBQUcsQ0FBQ2dFLFlBQVgsRUFBeUIsQ0FBRUMsQ0FBRCxJQUFPQSxDQUFDLENBQUMvQixRQUFWLENBQXpCLENBQWhCO0FBQ0EsU0FBT29CLGFBQWEsQ0FBQ1MsT0FBRCxFQUFVLENBQUMsUUFBRCxFQUFXLFNBQVgsRUFBc0IsU0FBdEIsRUFBaUMsWUFBakMsRUFBK0MsWUFBL0MsRUFBNkQsWUFBN0QsRUFBMkUsU0FBM0UsRUFBc0YsU0FBdEYsRUFBaUcsWUFBakcsRUFBK0csWUFBL0csQ0FBVixDQUFwQjtBQUNELENBSEQ7O0FBS0EsTUFBTUcsaUJBQWlCLEdBQUlDLE1BQUQsSUFBWTtBQUNwQ2pHLEVBQUFBLFdBQVcsQ0FBQ2lHLE1BQU0sQ0FBQ2hHLEdBQVIsQ0FBWCxDQUNHaUcsSUFESCxDQUNTQyxXQUFELElBQWlCO0FBQ3JCLFVBQU1DLGlCQUFpQixHQUFHUixXQUFXLENBQUNPLFdBQUQsQ0FBckM7QUFDQWhGLElBQUFBLFdBQVcsQ0FBQzhFLE1BQU0sQ0FBQ0ksU0FBUixDQUFYO0FBQ0FqRSxJQUFBQSxrQkFBa0IsQ0FDaEI2RCxNQUFNLENBQUNJLFNBRFMsRUFFaEJELGlCQUZnQixFQUdoQkgsTUFBTSxDQUFDSyxhQUhTLEVBSWhCTCxNQUFNLENBQUNNLGtCQUpTLEVBS2hCTixNQUFNLENBQUN6RCxlQUxTLEVBTWhCeUQsTUFBTSxDQUFDeEQsV0FOUyxDQUFsQjtBQVFELEdBWkgsRUFhRytELEtBYkgsQ0FhVUMsS0FBRCxJQUFXL0IsT0FBTyxDQUFDRyxHQUFSLENBQVk0QixLQUFaLENBYnBCO0FBY0EsU0FBTyxDQUFQO0FBQ0QsQ0FoQkQ7O2VBa0JlVCxpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIGZvckVhY2gsIHNvcnRCeSwgcmVkdWNlLFxufSBmcm9tICdsb2Rhc2gnO1xuXG4vLyB0b2RvIHZhbGlkYXRpb24gZnVuY3Rpb24gLy9odG1sNSArIGh0bWw0ICYmIElFIDEwLzExIHN1cHBvcnQ7XG4vLyB0b2RvXG5jb25zdCBzZW5kUmVxdWVzdCA9ICh1cmwpID0+IHtcbiAgLyogZXNsaW50LWRpc2FibGUgKi9cbiAgY29uc3QgeGh0dHAgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcblxuICBjb25zdCByZXEgPSBuZXcgUHJvbWlzZSgoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHhodHRwLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IDQgJiYgdGhpcy5zdGF0dXMgPT09IDIwMCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHhodHRwLnJlc3BvbnNlVGV4dDtcbiAgICAgICAgcmVzb2x2ZShKU09OLnBhcnNlKHJlc3VsdCkpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IDQgJiYgdGhpcy5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKGBFcnJvciEgJHt0aGlzLnJlYWR5U3RhdGV9ICR7dGhpcy5zdGF0dXN9YCkpO1xuICAgICAgfVxuICAgIH07XG4gICAgeGh0dHAub3BlbignUE9TVCcsIHVybCwgdHJ1ZSk7XG4gICAgeGh0dHAuc2V0UmVxdWVzdEhlYWRlcignQ29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpO1xuICAgIHhodHRwLnNlbmQoJ21vYmlsZV9jb2Rlcz1nZXQnKTtcbiAgfSkpO1xuICByZXR1cm4gcmVxO1xuICAvKiBlc2xpbnQtZW5hYmxlICovXG59O1xuXG5jb25zdCByZW5kZXJMYWJlbCA9IChvYmopID0+IHtcbiAgY29uc3QgbGFiZWxJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xhYmVsJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgbGFiZWxJbnB1dC5mb3IgPSBvYmouZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lucHV0JykuaWQ7XG4gIGxhYmVsSW5wdXQudGV4dENvbnRlbnQgPSAnICsnO1xuICBvYmouYXBwZW5kKGxhYmVsSW5wdXQpO1xuICByZXR1cm4gb2JqO1xufTtcblxuY29uc3QgbW9iaWxlRm9ybWF0ID0gKGFycikgPT4ge1xuICBjb25zdCBzdHIgPSByZWR1Y2UoYXJyLCAoYWNjLCBpdGVtLCBrZXkpID0+IHtcbiAgICBsZXQgcmVzID0gYWNjO1xuICAgIGlmIChrZXkgPT09IDIgfHwga2V5ID09PSA1KSB7XG4gICAgICByZXMgKz0gaXRlbTtcbiAgICAgIHJlcyArPSAnLSc7XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH1cbiAgICByZXMgKz0gaXRlbTtcbiAgICByZXR1cm4gcmVzO1xuICB9LCAnJyk7XG4gIHJldHVybiBzdHI7XG59O1xuXG5jb25zdCByZW5kZXJEcm9wRG93bkxpc3QgPSAob2JqLFxuICBTb3J0ZWRGbGFncyxcbiAgaW5wdXRNb2JpbGVEZWZhdWx0LFxuICBpbnB1dENvdW50cnlDb2RlRGVmYXVsdCxcbiAgaGlkZGVuSW5wdXROYW1lLFxuICBib3JkZXJTdHlsZSkgPT4ge1xuICBjb25zdCBkcm9wRG93bkhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICBjb25zdCBkcm9wRG93bklucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICBjb25zdCBkcm9wRG93bkxpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICBjb25zdCBkcm9wRG93bkhpZGRlbklucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuXG4gIGRyb3BEb3duTGlzdC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1kcm9wZG93bi1saXN0JztcbiAgZHJvcERvd25IZWFkZXIuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24taGVhZGVyJztcbiAgaWYgKGJvcmRlclN0eWxlID09PSAncmVkJykge1xuICAgIGRyb3BEb3duSW5wdXQuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24taW5wdXQtcmVkJztcbiAgfSBlbHNlIGlmIChib3JkZXJTdHlsZSA9PT0gJ2RlZmluZScpIHtcbiAgICBkcm9wRG93bklucHV0LmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLWRyb3Bkb3duLWlucHV0JztcbiAgfVxuXG5cbiAgZHJvcERvd25JbnB1dC5uYW1lID0gJ2NvdW50cnlfY29kZSc7XG4gIGRyb3BEb3duSW5wdXQucmVhZE9ubHkgPSB0cnVlO1xuICBkcm9wRG93bklucHV0LnBsYWNlaG9sZGVyID0gJ9C60L7QtCc7XG4gIGRyb3BEb3duSW5wdXQubWF4TGVuZ3RoID0gNDtcbiAgZHJvcERvd25JbnB1dC52YWx1ZSA9IGlucHV0Q291bnRyeUNvZGVEZWZhdWx0O1xuXG4gIGRyb3BEb3duSGlkZGVuSW5wdXQudHlwZSA9ICdoaWRkZW4nO1xuICBkcm9wRG93bkhpZGRlbklucHV0Lm5hbWUgPSBoaWRkZW5JbnB1dE5hbWUgfHwgJ21vYmlsZUlucHV0X01vYmlsZSc7XG5cbiAgZHJvcERvd25IZWFkZXIuYXBwZW5kKGRyb3BEb3duSW5wdXQpO1xuXG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndWwnKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICB1bC5jbGFzc05hbWUgPSAnbW9iaWxlX2lucHV0LS1kcm9wZG93bi11bCc7XG5cbiAgZm9yRWFjaChTb3J0ZWRGbGFncywgKGVsKSA9PiB7XG4gICAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgbGV0IGltZ0ZsYWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgICBsZXQgbGlUZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lXG4gICAgbGkuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24tbGknO1xuICAgIGltZ0ZsYWcuY2xhc3NOYW1lID0gJ21vYmlsZV9pbnB1dC0tZHJvcGRvd24taW1nZmxhZyc7XG4gICAgbGlUZXh0LmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLWRyb3Bkb3duLWxpdGV4dCc7XG5cbiAgICBsaVRleHQudGV4dENvbnRlbnQgPSBlbC5tb2JpbGVfY29kZTtcblxuICAgIGltZ0ZsYWcuc3R5bGUuYmFja2dyb3VuZEltYWdlID0gYHVybCguLi9pbWcvZmxhZ3MvJHtlbC5mbGFnX3BpY3R1cmVfbmFtZX0pYDtcbiAgICAvLyBpbWdGbGFnLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9IGB1cmwoaW1nL2ZsYWdzLyR7ZWwuZmxhZ19waWN0dXJlX25hbWV9KWA7XG5cbiAgICBsaS5hcHBlbmRDaGlsZChpbWdGbGFnKTtcbiAgICBsaS5hcHBlbmRDaGlsZChsaVRleHQpO1xuXG4gICAgbGkudGl0bGUgPSBlbC5uYW1lX2N5cjtcbiAgICBsaS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgIGRyb3BEb3duSW5wdXQudmFsdWUgPSBsaVRleHQudGV4dENvbnRlbnQ7XG4gICAgICBkcm9wRG93bkxpc3Quc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICB9KTtcbiAgICB1bC5hcHBlbmQobGkpO1xuICB9KTtcblxuICBkcm9wRG93bkxpc3QuYXBwZW5kKHVsKTtcblxuICBjb25zdCBtb2JpbGVJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgaWYgKGJvcmRlclN0eWxlID09PSAncmVkJykge1xuICAgIG1vYmlsZUlucHV0LmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLW1vYmlsZS1pbnB1dC1yZWQnO1xuICB9IGVsc2UgaWYgKGJvcmRlclN0eWxlID09PSAnZGVmaW5lJykge1xuICAgIG1vYmlsZUlucHV0LmNsYXNzTmFtZSA9ICdtb2JpbGVfaW5wdXQtLW1vYmlsZS1pbnB1dCc7XG4gIH1cblxuICBtb2JpbGVJbnB1dC5wYXR0ZXJuID0gJ1xcXFxkezN9KFxcXFxzfC0pXFxcXGR7M30oXFxcXHN8LSlcXFxcZHs0fSc7XG4gIG1vYmlsZUlucHV0LnBsYWNlaG9sZGVyID0gJ1hYWC1YWFgtWFhYWCc7XG4gIG1vYmlsZUlucHV0LnRpdGxlID0gJ9C90L7QvNC10YAg0LzQvtCx0LjQu9GM0L3QvtCz0L4g0YLQtdC70LXRhNC+0L3QsCc7XG4gIG1vYmlsZUlucHV0LnR5cGUgPSAndGVsJztcbiAgbW9iaWxlSW5wdXQucmVxdWlyZWQgPSB0cnVlO1xuICBtb2JpbGVJbnB1dC52YWx1ZSA9IG1vYmlsZUZvcm1hdChpbnB1dE1vYmlsZURlZmF1bHQpO1xuICBtb2JpbGVJbnB1dC5uYW1lID0gJ21vYmlsZV9udW1iZXInO1xuICBtb2JpbGVJbnB1dC5hdXRvY29tcGxldGUgPSAnb2ZmJztcblxuICBvYmouYXBwZW5kKGRyb3BEb3duSGVhZGVyKTtcblxuICBvYmouYXBwZW5kKG1vYmlsZUlucHV0KTtcblxuICBvYmouYXBwZW5kKGRyb3BEb3duTGlzdCk7XG5cbiAgZHJvcERvd25IaWRkZW5JbnB1dC52YWx1ZSA9IG1vYmlsZUZvcm1hdChpbnB1dE1vYmlsZURlZmF1bHQpO1xuXG4gIG9iai5hcHBlbmQoZHJvcERvd25IaWRkZW5JbnB1dCk7XG5cbiAgY29uc3QgSGlkZGVuSW5wdXRIYW5kbGVyID0gZnVuY3Rpb24gKCkge1xuICAgIGRyb3BEb3duSGlkZGVuSW5wdXQudmFsdWUgPSBkcm9wRG93bklucHV0LnZhbHVlICsgbW9iaWxlSW5wdXQudmFsdWU7XG4gICAgcmV0dXJuIGRyb3BEb3duSGlkZGVuSW5wdXQudmFsdWU7XG4gIH07XG5cbiAgY29uc3Qga2V5YnVmID0gaW5wdXRNb2JpbGVEZWZhdWx0LnNwbGl0KCcnKTtcbiAgY29uc29sZS53YXJuKCdpbnB1dE1vYmlsZURlZmF1bHQuc3BsaXQ6ICcsIGtleWJ1Zik7XG4gIC8vIGZpeG1lOiDQtNC+0YDQsNCx0L7RgtCw0YLRjCDQsdGD0YTQtdGAIC0g0L3QsNC00L4g0YHRh9C40YLRi9Cy0LDRgtGMINC30L3QsNGH0LXQvdC40LUgISEhIVxuICAvLyDQv9C+INGD0LzQvtC70YfQsNC90LjRjiDQsiDQsdGD0YTQtdGAICsg0L7QsdGA0LDQsdC+0YLQutCwINC90LDQttCw0YLQuNC5INGB0YLRgNC10LvQvtC6XG4gIG1vYmlsZUlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7IGNvbnNvbGUubG9nKGUua2V5KTsgfSk7XG4gIG1vYmlsZUlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4ge1xuICAgIGlmIChpc05hTihwYXJzZUludChlLmtleSwgMTApKSAmJiBlLmtleSAhPT0gJ0JhY2tzcGFjZScgJiYgZS5rZXkgIT09ICdFbnRlcicpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoa2V5YnVmLmxlbmd0aCA+PSAxMCAmJiBlLmtleSAhPT0gJ0JhY2tzcGFjZScpIHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGUua2V5ID09PSAnQmFja3NwYWNlJykge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgbW9iaWxlSW5wdXQudmFsdWUgPSAnJztcbiAgICAgIGtleWJ1Zi5wb3AoKTtcbiAgICAgIG1vYmlsZUlucHV0LnZhbHVlID0gbW9iaWxlRm9ybWF0KGtleWJ1Zik7XG4gICAgICBIaWRkZW5JbnB1dEhhbmRsZXIoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIG1vYmlsZUlucHV0LnZhbHVlID0gJyc7XG4gICAga2V5YnVmLnB1c2goZS5rZXkpO1xuICAgIG1vYmlsZUlucHV0LnZhbHVlID0gbW9iaWxlRm9ybWF0KGtleWJ1Zik7XG4gICAgSGlkZGVuSW5wdXRIYW5kbGVyKCk7XG4gIH0pO1xuXG4gIGRyb3BEb3duTGlzdC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgKCkgPT4ge1xuICAgIGRyb3BEb3duTGlzdC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgIEhpZGRlbklucHV0SGFuZGxlcigpO1xuICB9KTtcblxuICBkcm9wRG93bklucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgIGRyb3BEb3duTGlzdC5zdHlsZS5kaXNwbGF5ID0gKGRyb3BEb3duTGlzdC5zdHlsZS5kaXNwbGF5ID09PSAnYmxvY2snKSA/ICdub25lJyA6ICdibG9jayc7XG4gICAgSGlkZGVuSW5wdXRIYW5kbGVyKCk7XG4gIH0pO1xuXG4gIG1vYmlsZUlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2ZvY3VzaW4nLCAoKSA9PiB7XG4gICAgZHJvcERvd25MaXN0LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgSGlkZGVuSW5wdXRIYW5kbGVyKCk7XG4gIH0pO1xuXG4gIHJldHVybiBvYmo7XG59O1xuXG5jb25zdCB1cFVzZWRDb3VudHJ5ID0gKGNvZGVzLCBjb3VudHJpZXMpID0+IHtcbiAgY29uc3QgdXBMaXN0ID0gY29kZXMuZmlsdGVyKChlbCkgPT4gY291bnRyaWVzLmluY2x1ZGVzKGVsLm5hbWVfbGF0KSk7XG4gIGNvbnN0IHJlc3VsdCA9IHVwTGlzdC5jb25jYXQoY29kZXMpO1xuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgZm9ybWF0Q29kZXMgPSAoYXJyKSA9PiB7XG4gIGNvbnN0IHNvcnRBcnIgPSBzb3J0QnkoYXJyLm1vYmlsZV9jb2RlcywgWyhvKSA9PiBvLm5hbWVfY3lyXSk7XG4gIHJldHVybiB1cFVzZWRDb3VudHJ5KHNvcnRBcnIsIFsnUnVzc2lhJywgJ0JlbGFydXMnLCAnRmlubGFuZCcsICdLYXpha2hzdGFuJywgJ0t5cmd5enN0YW4nLCAnQXplcmJhaWphbicsICdBcm1lbmlhJywgJ01vbGRvdmEnLCAnVGFqaWtpc3RhbicsICdVemJla2lzdGFuJ10pO1xufTtcblxuY29uc3QgcmVuZGVyTW9iaWxlSW5wdXQgPSAoY29uZmlnKSA9PiB7XG4gIHNlbmRSZXF1ZXN0KGNvbmZpZy51cmwpXG4gICAgLnRoZW4oKE1vYmlsZUNvZGVzKSA9PiB7XG4gICAgICBjb25zdCBTb3J0ZWRNb2JpbGVDb2RlcyA9IGZvcm1hdENvZGVzKE1vYmlsZUNvZGVzKTtcbiAgICAgIHJlbmRlckxhYmVsKGNvbmZpZy5kb21PYmplY3QpO1xuICAgICAgcmVuZGVyRHJvcERvd25MaXN0KFxuICAgICAgICBjb25maWcuZG9tT2JqZWN0LFxuICAgICAgICBTb3J0ZWRNb2JpbGVDb2RlcyxcbiAgICAgICAgY29uZmlnLmRlZmF1bHRNb2JpbGUsXG4gICAgICAgIGNvbmZpZy5kZWZhdWx0Q291bnRyeUNvZGUsXG4gICAgICAgIGNvbmZpZy5oaWRkZW5JbnB1dE5hbWUsXG4gICAgICAgIGNvbmZpZy5ib3JkZXJTdHlsZSxcbiAgICAgICk7XG4gICAgfSlcbiAgICAuY2F0Y2goKGVycm9yKSA9PiBjb25zb2xlLmxvZyhlcnJvcikpO1xuICByZXR1cm4gMDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IHJlbmRlck1vYmlsZUlucHV0O1xuIl19